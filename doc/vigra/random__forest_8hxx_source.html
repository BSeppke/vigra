<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><TITLE>vigra - vigra/random_forest.hxx Source File</TITLE>
<link rel=stylesheet type="text/css" href="vigra.css">
<link rel=stylesheet type="text/css" href="vigra_1_8_2.css">
<link rel="shortcut icon" href="vigra-icon.ico" />
<script type="text/javascript">
function toggleHiddenDocumentation( textID, toggleID, toggleMessage )
{ 
	if( document.getElementById(textID).style.display == 'none' )
    {
		document.getElementById(textID).style.display = 'block';
        document.getElementById(toggleID).innerHTML = "hide " + toggleMessage;
    }
    else
    {
		document.getElementById(textID).style.display = 'none';
        document.getElementById(toggleID).innerHTML = "show " + toggleMessage;
	}
    return false;
}
</script>
</head>
<body  bgcolor="#f8f0e0" link="#0040b0" vlink="#a00040">
<basefont face="Helvetica,Arial,sans-serif" size=3>
<p align=right>
[ <a href="http://hci.iwr.uni-heidelberg.de/vigra/">VIGRA Homepage</a> |
 <a href="functionindex.html">Function Index</a> |
 <a href="classes.html">Class Index</a> |
 <a href="namespaces.html">Namespaces</a> |
 <a href="files.html">File List</a> |
 <a href="index.html">Main Page</a> ]
</p>
<!-- Generated by Doxygen 1.7.6.1 -->
</div>
<div class="contents">
<table class="main_heading">
<tr>
<td width="100%">vigra/random_forest.hxx
</td>
<td align=right><a href="http://hci.iwr.uni-heidelberg.de/vigra/"><IMG border=0 ALT="VIGRA" SRC="documents/vigra.gif" title="VIGRA Homepage"></a></td></tr>
</table><p>

<div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/************************************************************************/</span>
<a name="l00002"></a>00002 <span class="comment">/*                                                                      */</span>
<a name="l00003"></a>00003 <span class="comment">/*        Copyright 2008-2009 by  Ullrich Koethe and Rahul Nair         */</span>
<a name="l00004"></a>00004 <span class="comment">/*                                                                      */</span>
<a name="l00005"></a>00005 <span class="comment">/*    This file is part of the VIGRA computer vision library.           */</span>
<a name="l00006"></a>00006 <span class="comment">/*    The VIGRA Website is                                              */</span>
<a name="l00007"></a>00007 <span class="comment">/*        http://hci.iwr.uni-heidelberg.de/vigra/                       */</span>
<a name="l00008"></a>00008 <span class="comment">/*    Please direct questions, bug reports, and contributions to        */</span>
<a name="l00009"></a>00009 <span class="comment">/*        ullrich.koethe@iwr.uni-heidelberg.de    or                    */</span>
<a name="l00010"></a>00010 <span class="comment">/*        vigra@informatik.uni-hamburg.de                               */</span>
<a name="l00011"></a>00011 <span class="comment">/*                                                                      */</span>
<a name="l00012"></a>00012 <span class="comment">/*    Permission is hereby granted, free of charge, to any person       */</span>
<a name="l00013"></a>00013 <span class="comment">/*    obtaining a copy of this software and associated documentation    */</span>
<a name="l00014"></a>00014 <span class="comment">/*    files (the &quot;Software&quot;), to deal in the Software without           */</span>
<a name="l00015"></a>00015 <span class="comment">/*    restriction, including without limitation the rights to use,      */</span>
<a name="l00016"></a>00016 <span class="comment">/*    copy, modify, merge, publish, distribute, sublicense, and/or      */</span>
<a name="l00017"></a>00017 <span class="comment">/*    sell copies of the Software, and to permit persons to whom the    */</span>
<a name="l00018"></a>00018 <span class="comment">/*    Software is furnished to do so, subject to the following          */</span>
<a name="l00019"></a>00019 <span class="comment">/*    conditions:                                                       */</span>
<a name="l00020"></a>00020 <span class="comment">/*                                                                      */</span>
<a name="l00021"></a>00021 <span class="comment">/*    The above copyright notice and this permission notice shall be    */</span>
<a name="l00022"></a>00022 <span class="comment">/*    included in all copies or substantial portions of the             */</span>
<a name="l00023"></a>00023 <span class="comment">/*    Software.                                                         */</span>
<a name="l00024"></a>00024 <span class="comment">/*                                                                      */</span>
<a name="l00025"></a>00025 <span class="comment">/*    THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND    */</span>
<a name="l00026"></a>00026 <span class="comment">/*    EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES   */</span>
<a name="l00027"></a>00027 <span class="comment">/*    OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND          */</span>
<a name="l00028"></a>00028 <span class="comment">/*    NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT       */</span>
<a name="l00029"></a>00029 <span class="comment">/*    HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,      */</span>
<a name="l00030"></a>00030 <span class="comment">/*    WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING      */</span>
<a name="l00031"></a>00031 <span class="comment">/*    FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR     */</span>
<a name="l00032"></a>00032 <span class="comment">/*    OTHER DEALINGS IN THE SOFTWARE.                                   */</span>
<a name="l00033"></a>00033 <span class="comment">/*                                                                      */</span>
<a name="l00034"></a>00034 <span class="comment">/************************************************************************/</span>
<a name="l00035"></a>00035 
<a name="l00036"></a>00036 
<a name="l00037"></a>00037 <span class="preprocessor">#ifndef VIGRA_RANDOM_FOREST_HXX</span>
<a name="l00038"></a>00038 <span class="preprocessor"></span><span class="preprocessor">#define VIGRA_RANDOM_FOREST_HXX</span>
<a name="l00039"></a>00039 <span class="preprocessor"></span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &lt;iostream&gt;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &lt;algorithm&gt;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &lt;map&gt;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &lt;set&gt;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &lt;list&gt;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &lt;numeric&gt;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;mathutil.hxx&quot;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &quot;array_vector.hxx&quot;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &quot;sized_int.hxx&quot;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &quot;matrix.hxx&quot;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &quot;random.hxx&quot;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;functorexpression.hxx&quot;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &quot;random_forest/rf_common.hxx&quot;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &quot;random_forest/rf_nodeproxy.hxx&quot;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &quot;random_forest/rf_split.hxx&quot;</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &quot;random_forest/rf_decisionTree.hxx&quot;</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include &quot;random_forest/rf_visitors.hxx&quot;</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include &quot;random_forest/rf_region.hxx&quot;</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include &quot;sampling.hxx&quot;</span>
<a name="l00059"></a>00059 <span class="preprocessor">#include &quot;random_forest/rf_preprocessing.hxx&quot;</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include &quot;random_forest/rf_online_prediction_set.hxx&quot;</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include &quot;random_forest/rf_earlystopping.hxx&quot;</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include &quot;random_forest/rf_ridge_split.hxx&quot;</span>
<a name="l00063"></a>00063 <span class="keyword">namespace </span>vigra
<a name="l00064"></a>00064 {
<a name="l00065"></a>00065 <span class="comment"></span>
<a name="l00066"></a>00066 <span class="comment">/** \addtogroup MachineLearning Machine Learning</span>
<a name="l00067"></a>00067 <span class="comment"></span>
<a name="l00068"></a>00068 <span class="comment">    This module provides classification algorithms that map </span>
<a name="l00069"></a>00069 <span class="comment">    features to labels or label probabilities.</span>
<a name="l00070"></a>00070 <span class="comment">    Look at the RandomForest class first for a overview of most of the </span>
<a name="l00071"></a>00071 <span class="comment">    functionality provided as well as use cases. </span>
<a name="l00072"></a>00072 <span class="comment">**/</span><span class="comment"></span>
<a name="l00073"></a>00073 <span class="comment">//@{</span>
<a name="l00074"></a>00074 <span class="comment"></span>
<a name="l00075"></a>00075 <span class="keyword">namespace </span>detail
<a name="l00076"></a>00076 {
<a name="l00077"></a>00077 
<a name="l00078"></a>00078 
<a name="l00079"></a>00079 
<a name="l00080"></a>00080 <span class="comment">/* \brief sampling option factory function</span>
<a name="l00081"></a>00081 <span class="comment"> */</span>
<a name="l00082"></a>00082 <span class="keyword">inline</span> SamplerOptions make_sampler_opt ( RandomForestOptions     &amp; RF_opt)
<a name="l00083"></a>00083 {
<a name="l00084"></a>00084     SamplerOptions return_opt;
<a name="l00085"></a>00085     return_opt.<a class="code" href="classvigra_1_1SamplerOptions.html#a71724571dc7a52e5be40aefb51230397" title="Sample from training population with replacement.">withReplacement</a>(RF_opt.sample_with_replacement_);
<a name="l00086"></a>00086     return_opt.<a class="code" href="classvigra_1_1SamplerOptions.html#a849f4fbf15f9555862fd54dc2ffd178c" title="Draw equally many samples from each &quot;stratum&quot;. A stratum is a group of like entities, e.g. pixels belonging to the same object class. This is useful to create balanced samples when the class probabilities are very unbalanced (e.g. when there are many background and few foreground pixels). Stratified sampling thus avoids that a trained classifier is biased towards the majority class.">stratified</a>(RF_opt.stratification_method_ == RF_EQUAL);
<a name="l00087"></a>00087     <span class="keywordflow">return</span> return_opt;
<a name="l00088"></a>00088 }
<a name="l00089"></a>00089 }<span class="comment">//namespace detail</span>
<a name="l00090"></a>00090 <span class="comment"></span>
<a name="l00091"></a>00091 <span class="comment">/** Random Forest class</span>
<a name="l00092"></a>00092 <span class="comment"> *</span>
<a name="l00093"></a>00093 <span class="comment"> * \tparam &lt;LabelType = double&gt; Type used for predicted labels.</span>
<a name="l00094"></a>00094 <span class="comment"> * \tparam &lt;PreprocessorTag = ClassificationTag&gt; Class used to preprocess</span>
<a name="l00095"></a>00095 <span class="comment"> *          the input while learning and predicting. Currently Available:</span>
<a name="l00096"></a>00096 <span class="comment"> *          ClassificationTag and RegressionTag. It is recommended to use</span>
<a name="l00097"></a>00097 <span class="comment"> *          Splitfunctor::Preprocessor_t while using custom splitfunctors</span>
<a name="l00098"></a>00098 <span class="comment"> *          as they may need the data to be in a different format. </span>
<a name="l00099"></a>00099 <span class="comment"> *          \sa Preprocessor</span>
<a name="l00100"></a>00100 <span class="comment"> *  </span>
<a name="l00101"></a>00101 <span class="comment"> *  Simple usage for classification (regression is not yet supported):</span>
<a name="l00102"></a>00102 <span class="comment"> *  look at RandomForest::learn() as well as RandomForestOptions() for additional</span>
<a name="l00103"></a>00103 <span class="comment"> *  options. </span>
<a name="l00104"></a>00104 <span class="comment"> *</span>
<a name="l00105"></a>00105 <span class="comment"> *  \code</span>
<a name="l00106"></a>00106 <span class="comment"> *  using namespace vigra;</span>
<a name="l00107"></a>00107 <span class="comment"> *  using namespace rf;</span>
<a name="l00108"></a>00108 <span class="comment"> *  typedef xxx feature_t; \\ replace xxx with whichever type</span>
<a name="l00109"></a>00109 <span class="comment"> *  typedef yyy label_t;   \\ likewise </span>
<a name="l00110"></a>00110 <span class="comment"> *  </span>
<a name="l00111"></a>00111 <span class="comment"> *  // allocate the training data</span>
<a name="l00112"></a>00112 <span class="comment"> *  MultiArrayView&lt;2, feature_t&gt; f = get_training_features();</span>
<a name="l00113"></a>00113 <span class="comment"> *  MultiArrayView&lt;2, label_t&gt;   l = get_training_labels();</span>
<a name="l00114"></a>00114 <span class="comment"> *  </span>
<a name="l00115"></a>00115 <span class="comment"> *  RandomForest&lt;label_t&gt; rf;</span>
<a name="l00116"></a>00116 <span class="comment"> *</span>
<a name="l00117"></a>00117 <span class="comment"> *  // construct visitor to calculate out-of-bag error</span>
<a name="l00118"></a>00118 <span class="comment"> *  visitors::OOB_Error oob_v;</span>
<a name="l00119"></a>00119 <span class="comment"> *</span>
<a name="l00120"></a>00120 <span class="comment"> *  // perform training</span>
<a name="l00121"></a>00121 <span class="comment"> *  rf.learn(f, l, visitors::create_visitor(oob_v));</span>
<a name="l00122"></a>00122 <span class="comment"> *</span>
<a name="l00123"></a>00123 <span class="comment"> *  std::cout &lt;&lt; &quot;the out-of-bag error is: &quot; &lt;&lt; oob_v.oob_breiman &lt;&lt; &quot;\n&quot;;</span>
<a name="l00124"></a>00124 <span class="comment"> *      </span>
<a name="l00125"></a>00125 <span class="comment"> *  // get features for new data to be used for prediction</span>
<a name="l00126"></a>00126 <span class="comment"> *  MultiArrayView&lt;2, feature_t&gt; pf = get_features();</span>
<a name="l00127"></a>00127 <span class="comment"> *</span>
<a name="l00128"></a>00128 <span class="comment"> *  // allocate space for the response (pf.shape(0) is the number of samples)</span>
<a name="l00129"></a>00129 <span class="comment"> *  MultiArrayView&lt;2, label_t&gt; prediction(pf.shape(0), 1);</span>
<a name="l00130"></a>00130 <span class="comment"> *  MultiArrayView&lt;2, double&gt; prob(pf.shape(0), rf.class_count());</span>
<a name="l00131"></a>00131 <span class="comment"> *      </span>
<a name="l00132"></a>00132 <span class="comment"> *  // perform prediction on new data</span>
<a name="l00133"></a>00133 <span class="comment"> *  rf.predictLabels(pf, prediction);</span>
<a name="l00134"></a>00134 <span class="comment"> *  rf.predictProbabilities(pf, prob);</span>
<a name="l00135"></a>00135 <span class="comment"> *</span>
<a name="l00136"></a>00136 <span class="comment"> *  \endcode</span>
<a name="l00137"></a>00137 <span class="comment"> *</span>
<a name="l00138"></a>00138 <span class="comment"> *  Additional information such as Variable Importance measures are accessed</span>
<a name="l00139"></a>00139 <span class="comment"> *  via Visitors defined in rf::visitors. </span>
<a name="l00140"></a>00140 <span class="comment"> *  Have a look at rf::split for other splitting methods.</span>
<a name="l00141"></a>00141 <span class="comment"> *</span>
<a name="l00142"></a>00142 <span class="comment">*/</span>
<a name="l00143"></a>00143 <span class="keyword">template</span> &lt;<span class="keyword">class</span> LabelType = <span class="keywordtype">double</span> , <span class="keyword">class</span> PreprocessorTag = ClassificationTag &gt;
<a name="l00144"></a><a class="code" href="classvigra_1_1RandomForest.html">00144</a> <span class="keyword">class </span><a class="code" href="classvigra_1_1RandomForest.html">RandomForest</a>
<a name="l00145"></a>00145 {
<a name="l00146"></a>00146 
<a name="l00147"></a>00147   <span class="keyword">public</span>:
<a name="l00148"></a>00148     <span class="comment">//public typedefs</span>
<a name="l00149"></a>00149     <span class="keyword">typedef</span> <a class="code" href="classvigra_1_1RandomForestOptions.html" title="Options object for the random forest.">RandomForestOptions</a>             <a class="code" href="classvigra_1_1RandomForestOptions.html" title="Options object for the random forest.">Options_t</a>;
<a name="l00150"></a>00150     <span class="keyword">typedef</span> detail::DecisionTree            DecisionTree_t;
<a name="l00151"></a>00151     <span class="keyword">typedef</span> <a class="code" href="classvigra_1_1ProblemSpec.html" title="problem specification class for the random forest.">ProblemSpec&lt;LabelType&gt;</a>          <a class="code" href="classvigra_1_1ProblemSpec.html" title="problem specification class for the random forest.">ProblemSpec_t</a>;
<a name="l00152"></a>00152     <span class="keyword">typedef</span> <a class="code" href="classvigra_1_1ThresholdSplit.html">GiniSplit</a>                       <a class="code" href="classvigra_1_1ThresholdSplit.html">Default_Split_t</a>;
<a name="l00153"></a>00153     <span class="keyword">typedef</span> <a class="code" href="classvigra_1_1EarlyStoppStd.html" title="Standard early stopping criterion.">EarlyStoppStd</a>                   <a class="code" href="classvigra_1_1EarlyStoppStd.html" title="Standard early stopping criterion.">Default_Stop_t</a>;
<a name="l00154"></a>00154     <span class="keyword">typedef</span> <a class="code" href="classvigra_1_1rf_1_1visitors_1_1StopVisiting.html">rf::visitors::StopVisiting</a>      <a class="code" href="classvigra_1_1rf_1_1visitors_1_1StopVisiting.html">Default_Visitor_t</a>;
<a name="l00155"></a>00155     <span class="keyword">typedef</span>  <a class="code" href="classvigra_1_1DT__StackEntry.html">DT_StackEntry&lt;ArrayVectorView&lt;Int32&gt;::iterator</a>&gt;
<a name="l00156"></a>00156                     <a class="code" href="classvigra_1_1DT__StackEntry.html">StackEntry_t</a>;
<a name="l00157"></a>00157     <span class="keyword">typedef</span> LabelType                       LabelT; 
<a name="l00158"></a>00158 
<a name="l00159"></a>00159     <span class="comment">//problem independent data.</span>
<a name="l00160"></a>00160     <a class="code" href="classvigra_1_1RandomForestOptions.html" title="Options object for the random forest.">Options_t</a>                                   options_;
<a name="l00161"></a>00161     <span class="comment">//problem dependent data members - is only set if</span>
<a name="l00162"></a>00162     <span class="comment">//a copy constructor, some sort of import</span>
<a name="l00163"></a>00163     <span class="comment">//function or the learn function is called</span>
<a name="l00164"></a>00164     <a class="code" href="classvigra_1_1ArrayVector.html">ArrayVector&lt;DecisionTree_t&gt;</a>                 trees_;
<a name="l00165"></a>00165     <a class="code" href="classvigra_1_1ProblemSpec.html" title="problem specification class for the random forest.">ProblemSpec_t</a>                               ext_param_;
<a name="l00166"></a>00166     <span class="comment">/*mutable ArrayVector&lt;int&gt;                    tree_indices_;*/</span>
<a name="l00167"></a>00167     <a class="code" href="classvigra_1_1rf_1_1visitors_1_1OnlineLearnVisitor.html">rf::visitors::OnlineLearnVisitor</a>            online_visitor_;
<a name="l00168"></a>00168 
<a name="l00169"></a>00169 
<a name="l00170"></a>00170     <span class="keywordtype">void</span> reset()
<a name="l00171"></a>00171     {
<a name="l00172"></a>00172         ext_param_.clear();
<a name="l00173"></a>00173         trees_.clear();
<a name="l00174"></a>00174     }
<a name="l00175"></a>00175 
<a name="l00176"></a>00176   <span class="keyword">public</span>:
<a name="l00177"></a>00177 <span class="comment"></span>
<a name="l00178"></a>00178 <span class="comment">    /** \name Constructors</span>
<a name="l00179"></a>00179 <span class="comment">     * Note: No copy Constructor specified as no pointers are manipulated</span>
<a name="l00180"></a>00180 <span class="comment">     * in this class</span>
<a name="l00181"></a>00181 <span class="comment">     */</span>
<a name="l00182"></a>00182     <span class="comment">/*\{*/</span><span class="comment"></span>
<a name="l00183"></a>00183 <span class="comment">    /**\brief default constructor</span>
<a name="l00184"></a>00184 <span class="comment">     *</span>
<a name="l00185"></a>00185 <span class="comment">     * \param options   general options to the Random Forest. Must be of Type</span>
<a name="l00186"></a>00186 <span class="comment">     *                  Options_t</span>
<a name="l00187"></a>00187 <span class="comment">     * \param ext_param problem specific values that can be supplied </span>
<a name="l00188"></a>00188 <span class="comment">     *                  additionally. (class weights , labels etc)</span>
<a name="l00189"></a>00189 <span class="comment">     * \sa  RandomForestOptions, ProblemSpec</span>
<a name="l00190"></a>00190 <span class="comment">     *</span>
<a name="l00191"></a>00191 <span class="comment">     */</span>
<a name="l00192"></a><a class="code" href="classvigra_1_1RandomForest.html#a333e71f47b2197ab6b6db18d50e7fc3a">00192</a>     <a class="code" href="classvigra_1_1RandomForest.html#a333e71f47b2197ab6b6db18d50e7fc3a" title="default constructor">RandomForest</a>(<a class="code" href="classvigra_1_1RandomForestOptions.html" title="Options object for the random forest.">Options_t</a> <span class="keyword">const</span> &amp; <a class="code" href="classvigra_1_1RandomForest.html#a8eae2156ea49cc300405359243b44e23" title="access const random forest options">options</a> = <a class="code" href="classvigra_1_1RandomForestOptions.html" title="Options object for the random forest.">Options_t</a>(), 
<a name="l00193"></a>00193                  <a class="code" href="classvigra_1_1ProblemSpec.html" title="problem specification class for the random forest.">ProblemSpec_t</a> <span class="keyword">const</span> &amp; <a class="code" href="classvigra_1_1RandomForest.html#a8be3a3faa1f6c460f44a5a39439e2534" title="return external parameters for viewing">ext_param</a> = <a class="code" href="classvigra_1_1ProblemSpec.html" title="problem specification class for the random forest.">ProblemSpec_t</a>())
<a name="l00194"></a>00194     :
<a name="l00195"></a>00195         options_(<a class="code" href="classvigra_1_1RandomForest.html#a8eae2156ea49cc300405359243b44e23" title="access const random forest options">options</a>),
<a name="l00196"></a>00196         ext_param_(<a class="code" href="classvigra_1_1RandomForest.html#a8be3a3faa1f6c460f44a5a39439e2534" title="return external parameters for viewing">ext_param</a>)<span class="comment">/*,</span>
<a name="l00197"></a>00197 <span class="comment">        tree_indices_(options.tree_count_,0)*/</span>
<a name="l00198"></a>00198     {
<a name="l00199"></a>00199         <span class="comment">/*for(int ii = 0 ; ii &lt; int(tree_indices_.size()); ++ii)</span>
<a name="l00200"></a>00200 <span class="comment">            tree_indices_[ii] = ii;*/</span>
<a name="l00201"></a>00201     }
<a name="l00202"></a>00202 <span class="comment"></span>
<a name="l00203"></a>00203 <span class="comment">    /**\brief Create RF from external source</span>
<a name="l00204"></a>00204 <span class="comment">     * \param treeCount Number of trees to add.</span>
<a name="l00205"></a>00205 <span class="comment">     * \param topology_begin     </span>
<a name="l00206"></a>00206 <span class="comment">     *                  Iterator to a Container where the topology_ data</span>
<a name="l00207"></a>00207 <span class="comment">     *                  of the trees are stored.</span>
<a name="l00208"></a>00208 <span class="comment">     *                  Iterator should support at least treeCount forward </span>
<a name="l00209"></a>00209 <span class="comment">     *                  iterations. (i.e. topology_end - topology_begin &gt;= treeCount</span>
<a name="l00210"></a>00210 <span class="comment">     * \param parameter_begin  </span>
<a name="l00211"></a>00211 <span class="comment">     *                  iterator to a Container where the parameters_ data</span>
<a name="l00212"></a>00212 <span class="comment">     *                  of the trees are stored. Iterator should support at </span>
<a name="l00213"></a>00213 <span class="comment">     *                  least treeCount forward iterations.</span>
<a name="l00214"></a>00214 <span class="comment">     * \param problem_spec </span>
<a name="l00215"></a>00215 <span class="comment">     *                  Extrinsic parameters that specify the problem e.g.</span>
<a name="l00216"></a>00216 <span class="comment">     *                  ClassCount, featureCount etc.</span>
<a name="l00217"></a>00217 <span class="comment">     * \param options   (optional) specify options used to train the original</span>
<a name="l00218"></a>00218 <span class="comment">     *                  Random forest. This parameter is not used anywhere</span>
<a name="l00219"></a>00219 <span class="comment">     *                  during prediction and thus is optional.</span>
<a name="l00220"></a>00220 <span class="comment">     *</span>
<a name="l00221"></a>00221 <span class="comment">     */</span>
<a name="l00222"></a>00222      <span class="comment">/* TODO: This constructor may be replaced by a Constructor using</span>
<a name="l00223"></a>00223 <span class="comment">     * NodeProxy iterators to encapsulate the underlying data type.</span>
<a name="l00224"></a>00224 <span class="comment">     */</span>
<a name="l00225"></a>00225     <span class="keyword">template</span>&lt;<span class="keyword">class</span> TopologyIterator, <span class="keyword">class</span> ParameterIterator&gt;
<a name="l00226"></a><a class="code" href="classvigra_1_1RandomForest.html#a04b9a3f032fdb72129dc22bc1781860b">00226</a>     <a class="code" href="classvigra_1_1RandomForest.html#a333e71f47b2197ab6b6db18d50e7fc3a" title="default constructor">RandomForest</a>(<span class="keywordtype">int</span>                       treeCount,
<a name="l00227"></a>00227                   TopologyIterator         topology_begin,
<a name="l00228"></a>00228                   ParameterIterator        parameter_begin,
<a name="l00229"></a>00229                   <a class="code" href="classvigra_1_1ProblemSpec.html" title="problem specification class for the random forest.">ProblemSpec_t</a> <span class="keyword">const</span> &amp; problem_spec,
<a name="l00230"></a>00230                   <a class="code" href="classvigra_1_1RandomForestOptions.html" title="Options object for the random forest.">Options_t</a> <span class="keyword">const</span> &amp;     <a class="code" href="classvigra_1_1RandomForest.html#a8eae2156ea49cc300405359243b44e23" title="access const random forest options">options</a> = <a class="code" href="classvigra_1_1RandomForestOptions.html" title="Options object for the random forest.">Options_t</a>())
<a name="l00231"></a>00231     :
<a name="l00232"></a>00232         trees_(treeCount, DecisionTree_t(problem_spec)),
<a name="l00233"></a>00233         ext_param_(problem_spec),
<a name="l00234"></a>00234         options_(<a class="code" href="classvigra_1_1RandomForest.html#a8eae2156ea49cc300405359243b44e23" title="access const random forest options">options</a>)
<a name="l00235"></a>00235     {
<a name="l00236"></a>00236         <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> k=0; k&lt;treeCount; ++k, ++topology_begin, ++parameter_begin)
<a name="l00237"></a>00237         {
<a name="l00238"></a>00238             trees_[k].topology_ = *topology_begin;
<a name="l00239"></a>00239             trees_[k].parameters_ = *parameter_begin;
<a name="l00240"></a>00240         }
<a name="l00241"></a>00241     }
<a name="l00242"></a>00242 
<a name="l00243"></a>00243     <span class="comment">/*\}*/</span>
<a name="l00244"></a>00244 
<a name="l00245"></a>00245 <span class="comment"></span>
<a name="l00246"></a>00246 <span class="comment">    /** \name Data Access</span>
<a name="l00247"></a>00247 <span class="comment">     * data access interface - usage of member variables is deprecated</span>
<a name="l00248"></a>00248 <span class="comment">     */</span>
<a name="l00249"></a>00249 
<a name="l00250"></a>00250     <span class="comment">/*\{*/</span>
<a name="l00251"></a>00251 
<a name="l00252"></a>00252 <span class="comment"></span>
<a name="l00253"></a>00253 <span class="comment">    /**\brief return external parameters for viewing</span>
<a name="l00254"></a>00254 <span class="comment">     * \return ProblemSpec_t</span>
<a name="l00255"></a>00255 <span class="comment">     */</span>
<a name="l00256"></a><a class="code" href="classvigra_1_1RandomForest.html#a8be3a3faa1f6c460f44a5a39439e2534">00256</a>     <a class="code" href="classvigra_1_1ProblemSpec.html" title="problem specification class for the random forest.">ProblemSpec_t</a> <span class="keyword">const</span> &amp; <a class="code" href="classvigra_1_1RandomForest.html#a8be3a3faa1f6c460f44a5a39439e2534" title="return external parameters for viewing">ext_param</a>()<span class="keyword"> const</span>
<a name="l00257"></a>00257 <span class="keyword">    </span>{
<a name="l00258"></a>00258         vigra_precondition(ext_param_.used() == <span class="keyword">true</span>,
<a name="l00259"></a>00259            <span class="stringliteral">&quot;RandomForest::ext_param(): &quot;</span>
<a name="l00260"></a>00260            <span class="stringliteral">&quot;Random forest has not been trained yet.&quot;</span>);
<a name="l00261"></a>00261         <span class="keywordflow">return</span> ext_param_;
<a name="l00262"></a>00262     }
<a name="l00263"></a>00263 <span class="comment"></span>
<a name="l00264"></a>00264 <span class="comment">    /**\brief set external parameters</span>
<a name="l00265"></a>00265 <span class="comment">     *</span>
<a name="l00266"></a>00266 <span class="comment">     *  \param in external parameters to be set</span>
<a name="l00267"></a>00267 <span class="comment">     *</span>
<a name="l00268"></a>00268 <span class="comment">     * set external parameters explicitly. </span>
<a name="l00269"></a>00269 <span class="comment">     * If Random Forest has not been trained the preprocessor will </span>
<a name="l00270"></a>00270 <span class="comment">     * either ignore filling values set this way or will throw an exception </span>
<a name="l00271"></a>00271 <span class="comment">     * if values specified manually do not match the value calculated </span>
<a name="l00272"></a>00272 <span class="comment">     &amp; during the preparation step.</span>
<a name="l00273"></a>00273 <span class="comment">     */</span>
<a name="l00274"></a><a class="code" href="classvigra_1_1RandomForest.html#a278cd4498ffaa9e513b5c4248fff68be">00274</a>     <span class="keywordtype">void</span> <a class="code" href="classvigra_1_1RandomForest.html#a278cd4498ffaa9e513b5c4248fff68be" title="set external parameters">set_ext_param</a>(<a class="code" href="classvigra_1_1ProblemSpec.html" title="problem specification class for the random forest.">ProblemSpec_t</a> <span class="keyword">const</span> &amp; in)
<a name="l00275"></a>00275     {
<a name="l00276"></a>00276         vigra_precondition(ext_param_.used() == <span class="keyword">false</span>,
<a name="l00277"></a>00277             <span class="stringliteral">&quot;RandomForest::set_ext_param():&quot;</span>
<a name="l00278"></a>00278             <span class="stringliteral">&quot;Random forest has been trained! Call reset()&quot;</span>
<a name="l00279"></a>00279             <span class="stringliteral">&quot;before specifying new extrinsic parameters.&quot;</span>);
<a name="l00280"></a>00280     }
<a name="l00281"></a>00281 <span class="comment"></span>
<a name="l00282"></a>00282 <span class="comment">    /**\brief access random forest options</span>
<a name="l00283"></a>00283 <span class="comment">     *</span>
<a name="l00284"></a>00284 <span class="comment">     * \return random forest options</span>
<a name="l00285"></a>00285 <span class="comment">     */</span>
<a name="l00286"></a><a class="code" href="classvigra_1_1RandomForest.html#acf93289f0400da36167d02532ee786f4">00286</a>     <a class="code" href="classvigra_1_1RandomForestOptions.html" title="Options object for the random forest.">Options_t</a> &amp; <a class="code" href="classvigra_1_1RandomForest.html#acf93289f0400da36167d02532ee786f4" title="access random forest options">set_options</a>()
<a name="l00287"></a>00287     {
<a name="l00288"></a>00288         <span class="keywordflow">return</span> <a class="code" href="classvigra_1_1RandomForest.html#a8eae2156ea49cc300405359243b44e23" title="access const random forest options">options</a>;
<a name="l00289"></a>00289     }
<a name="l00290"></a>00290 
<a name="l00291"></a>00291 <span class="comment"></span>
<a name="l00292"></a>00292 <span class="comment">    /**\brief access const random forest options</span>
<a name="l00293"></a>00293 <span class="comment">     *</span>
<a name="l00294"></a>00294 <span class="comment">     * \return const Option_t</span>
<a name="l00295"></a>00295 <span class="comment">     */</span>
<a name="l00296"></a><a class="code" href="classvigra_1_1RandomForest.html#a8eae2156ea49cc300405359243b44e23">00296</a>     <a class="code" href="classvigra_1_1RandomForestOptions.html" title="Options object for the random forest.">Options_t</a> <span class="keyword">const</span> &amp; <a class="code" href="classvigra_1_1RandomForest.html#a8eae2156ea49cc300405359243b44e23" title="access const random forest options">options</a>()<span class="keyword"> const</span>
<a name="l00297"></a>00297 <span class="keyword">    </span>{
<a name="l00298"></a>00298         <span class="keywordflow">return</span> options_;
<a name="l00299"></a>00299     }
<a name="l00300"></a>00300 <span class="comment"></span>
<a name="l00301"></a>00301 <span class="comment">    /**\brief access const trees</span>
<a name="l00302"></a>00302 <span class="comment">     */</span>
<a name="l00303"></a><a class="code" href="classvigra_1_1RandomForest.html#a2782c3291acfa66c8f306288fc8e7196">00303</a>     DecisionTree_t <span class="keyword">const</span> &amp; <a class="code" href="classvigra_1_1RandomForest.html#a2782c3291acfa66c8f306288fc8e7196" title="access const trees">tree</a>(<span class="keywordtype">int</span> index)<span class="keyword"> const</span>
<a name="l00304"></a>00304 <span class="keyword">    </span>{
<a name="l00305"></a>00305         <span class="keywordflow">return</span> trees_[index];
<a name="l00306"></a>00306     }
<a name="l00307"></a>00307 <span class="comment"></span>
<a name="l00308"></a>00308 <span class="comment">    /**\brief access trees</span>
<a name="l00309"></a>00309 <span class="comment">     */</span>
<a name="l00310"></a><a class="code" href="classvigra_1_1RandomForest.html#aad23f94673a4f0a72328a1a4c16adfee">00310</a>     DecisionTree_t &amp; <a class="code" href="classvigra_1_1RandomForest.html#a2782c3291acfa66c8f306288fc8e7196" title="access const trees">tree</a>(<span class="keywordtype">int</span> index)
<a name="l00311"></a>00311     {
<a name="l00312"></a>00312         <span class="keywordflow">return</span> trees_[index];
<a name="l00313"></a>00313     }
<a name="l00314"></a>00314 
<a name="l00315"></a>00315     <span class="comment">/*\}*/</span>
<a name="l00316"></a>00316 <span class="comment"></span>
<a name="l00317"></a>00317 <span class="comment">    /**\brief return number of features used while </span>
<a name="l00318"></a>00318 <span class="comment">     * training.</span>
<a name="l00319"></a>00319 <span class="comment">     */</span>
<a name="l00320"></a><a class="code" href="classvigra_1_1RandomForest.html#a9bd0ac979ee86f839b3c4574e6f95f58">00320</a>     <span class="keywordtype">int</span> <a class="code" href="classvigra_1_1RandomForest.html#a9bd0ac979ee86f839b3c4574e6f95f58" title="return number of features used while training.">feature_count</a>()<span class="keyword"> const</span>
<a name="l00321"></a>00321 <span class="keyword">    </span>{
<a name="l00322"></a>00322       <span class="keywordflow">return</span> ext_param_.column_count_;
<a name="l00323"></a>00323     }
<a name="l00324"></a>00324     
<a name="l00325"></a>00325     <span class="comment"></span>
<a name="l00326"></a>00326 <span class="comment">    /**\brief return number of features used while </span>
<a name="l00327"></a>00327 <span class="comment">     * training.</span>
<a name="l00328"></a>00328 <span class="comment">     *</span>
<a name="l00329"></a>00329 <span class="comment">     * deprecated. Use feature_count() instead.</span>
<a name="l00330"></a>00330 <span class="comment">     */</span>
<a name="l00331"></a><a class="code" href="classvigra_1_1RandomForest.html#acd888c75c503a4f3d2ede13bf1d714c2">00331</a>     <span class="keywordtype">int</span> <a class="code" href="classvigra_1_1RandomForest.html#acd888c75c503a4f3d2ede13bf1d714c2" title="return number of features used while training.">column_count</a>()<span class="keyword"> const</span>
<a name="l00332"></a>00332 <span class="keyword">    </span>{
<a name="l00333"></a>00333       <span class="keywordflow">return</span> ext_param_.column_count_;
<a name="l00334"></a>00334     }
<a name="l00335"></a>00335 <span class="comment"></span>
<a name="l00336"></a>00336 <span class="comment">    /**\brief return number of classes used while </span>
<a name="l00337"></a>00337 <span class="comment">     * training.</span>
<a name="l00338"></a>00338 <span class="comment">     */</span>
<a name="l00339"></a><a class="code" href="classvigra_1_1RandomForest.html#aa923211d8be473d9ea70329ed9e2e72d">00339</a>     <span class="keywordtype">int</span> <a class="code" href="classvigra_1_1RandomForest.html#aa923211d8be473d9ea70329ed9e2e72d" title="return number of classes used while training.">class_count</a>()<span class="keyword"> const</span>
<a name="l00340"></a>00340 <span class="keyword">    </span>{
<a name="l00341"></a>00341       <span class="keywordflow">return</span> ext_param_.class_count_;
<a name="l00342"></a>00342     }
<a name="l00343"></a>00343 <span class="comment"></span>
<a name="l00344"></a>00344 <span class="comment">    /**\brief return number of trees</span>
<a name="l00345"></a>00345 <span class="comment">     */</span>
<a name="l00346"></a><a class="code" href="classvigra_1_1RandomForest.html#a230d05321ffe94cb138c13bd4ed71e76">00346</a>     <span class="keywordtype">int</span> <a class="code" href="classvigra_1_1RandomForest.html#a230d05321ffe94cb138c13bd4ed71e76" title="return number of trees">tree_count</a>()<span class="keyword"> const</span>
<a name="l00347"></a>00347 <span class="keyword">    </span>{
<a name="l00348"></a>00348       <span class="keywordflow">return</span> options_.tree_count_;
<a name="l00349"></a>00349     }
<a name="l00350"></a>00350 
<a name="l00351"></a>00351 
<a name="l00352"></a>00352     
<a name="l00353"></a>00353     <span class="keyword">template</span>&lt;<span class="keyword">class </span>U,<span class="keyword">class </span>C1,
<a name="l00354"></a>00354         <span class="keyword">class </span>U2, <span class="keyword">class </span>C2,
<a name="l00355"></a>00355         <span class="keyword">class </span>Split_t,
<a name="l00356"></a>00356         <span class="keyword">class </span>Stop_t,
<a name="l00357"></a>00357         <span class="keyword">class </span>Visitor_t,
<a name="l00358"></a>00358         <span class="keyword">class </span>Random_t&gt;
<a name="l00359"></a>00359     <span class="keywordtype">void</span> onlineLearn(   <a class="code" href="classvigra_1_1MultiArrayView.html" title="Base class for, and view to, vigra::MultiArray.">MultiArrayView&lt;2,U,C1&gt;</a> <span class="keyword">const</span> &amp; features,
<a name="l00360"></a>00360                         <a class="code" href="classvigra_1_1MultiArrayView.html" title="Base class for, and view to, vigra::MultiArray.">MultiArrayView&lt;2,U2,C2&gt;</a> <span class="keyword">const</span> &amp; response,
<a name="l00361"></a>00361                         <span class="keywordtype">int</span> new_start_index,
<a name="l00362"></a>00362                         Visitor_t visitor_,
<a name="l00363"></a>00363                         Split_t split_,
<a name="l00364"></a>00364                         Stop_t stop_,
<a name="l00365"></a>00365                         Random_t &amp; random,
<a name="l00366"></a>00366                         <span class="keywordtype">bool</span> adjust_thresholds=<span class="keyword">false</span>);
<a name="l00367"></a>00367 
<a name="l00368"></a>00368     <span class="keyword">template</span> &lt;<span class="keyword">class</span> U, <span class="keyword">class</span> C1, <span class="keyword">class</span> U2,<span class="keyword">class</span> C2&gt;
<a name="l00369"></a>00369     <span class="keywordtype">void</span> onlineLearn(   <a class="code" href="classvigra_1_1MultiArrayView.html" title="Base class for, and view to, vigra::MultiArray.">MultiArrayView&lt;2, U, C1&gt;</a> <span class="keyword">const</span>  &amp; features,
<a name="l00370"></a>00370                         <a class="code" href="classvigra_1_1MultiArrayView.html" title="Base class for, and view to, vigra::MultiArray.">MultiArrayView&lt;2, U2,C2&gt;</a> <span class="keyword">const</span>  &amp; labels,<span class="keywordtype">int</span> new_start_index,<span class="keywordtype">bool</span> adjust_thresholds=<span class="keyword">false</span>)
<a name="l00371"></a>00371     {
<a name="l00372"></a>00372         <a class="code" href="classvigra_1_1RandomNumberGenerator.html">RandomNumberGenerator&lt;&gt;</a> rnd = <a class="code" href="classvigra_1_1RandomNumberGenerator.html">RandomNumberGenerator&lt;&gt;</a>(RandomSeed);
<a name="l00373"></a>00373         onlineLearn(features, 
<a name="l00374"></a>00374                     labels, 
<a name="l00375"></a>00375                     new_start_index,
<a name="l00376"></a>00376                     <a class="code" href="namespacevigra.html#ae19ed2482e705ffa14000822902fc131" title="factory function to return a RF_DEFAULT tag">rf_default</a>(), 
<a name="l00377"></a>00377                     <a class="code" href="namespacevigra.html#ae19ed2482e705ffa14000822902fc131" title="factory function to return a RF_DEFAULT tag">rf_default</a>(), 
<a name="l00378"></a>00378                     <a class="code" href="namespacevigra.html#ae19ed2482e705ffa14000822902fc131" title="factory function to return a RF_DEFAULT tag">rf_default</a>(),
<a name="l00379"></a>00379                     rnd,
<a name="l00380"></a>00380                     adjust_thresholds);
<a name="l00381"></a>00381     }
<a name="l00382"></a>00382 
<a name="l00383"></a>00383     <span class="keyword">template</span>&lt;<span class="keyword">class </span>U,<span class="keyword">class </span>C1,
<a name="l00384"></a>00384         <span class="keyword">class </span>U2, <span class="keyword">class </span>C2,
<a name="l00385"></a>00385         <span class="keyword">class </span>Split_t,
<a name="l00386"></a>00386         <span class="keyword">class </span>Stop_t,
<a name="l00387"></a>00387         <span class="keyword">class </span>Visitor_t,
<a name="l00388"></a>00388         <span class="keyword">class </span>Random_t&gt;
<a name="l00389"></a>00389     <span class="keywordtype">void</span> <a class="code" href="group__MachineLearning.html#gae1ccc1e1d0b2d4aaec94005e775b4db2">reLearnTree</a>(MultiArrayView&lt;2,U,C1&gt; <span class="keyword">const</span> &amp; features,
<a name="l00390"></a>00390                      MultiArrayView&lt;2,U2,C2&gt; <span class="keyword">const</span> &amp; response,
<a name="l00391"></a>00391                      <span class="keywordtype">int</span> treeId,
<a name="l00392"></a>00392                      Visitor_t visitor_,
<a name="l00393"></a>00393                      Split_t split_,
<a name="l00394"></a>00394                      Stop_t stop_,
<a name="l00395"></a>00395                      Random_t &amp; random);
<a name="l00396"></a>00396 
<a name="l00397"></a>00397     <span class="keyword">template</span>&lt;<span class="keyword">class</span> U, <span class="keyword">class</span> C1, <span class="keyword">class</span> U2, <span class="keyword">class</span> C2&gt;
<a name="l00398"></a>00398     <span class="keywordtype">void</span> <a class="code" href="group__MachineLearning.html#gae1ccc1e1d0b2d4aaec94005e775b4db2">reLearnTree</a>(MultiArrayView&lt;2, U, C1&gt; <span class="keyword">const</span> &amp; features,
<a name="l00399"></a>00399                      MultiArrayView&lt;2, U2, C2&gt; <span class="keyword">const</span> &amp; labels,
<a name="l00400"></a>00400                      <span class="keywordtype">int</span> treeId)
<a name="l00401"></a>00401     {
<a name="l00402"></a>00402         RandomNumberGenerator&lt;&gt; rnd = RandomNumberGenerator&lt;&gt;(RandomSeed);
<a name="l00403"></a>00403         <a class="code" href="group__MachineLearning.html#gae1ccc1e1d0b2d4aaec94005e775b4db2">reLearnTree</a>(features,
<a name="l00404"></a>00404                     labels,
<a name="l00405"></a>00405                     treeId,
<a name="l00406"></a>00406                     <a class="code" href="namespacevigra.html#ae19ed2482e705ffa14000822902fc131" title="factory function to return a RF_DEFAULT tag">rf_default</a>(),
<a name="l00407"></a>00407                     <a class="code" href="namespacevigra.html#ae19ed2482e705ffa14000822902fc131" title="factory function to return a RF_DEFAULT tag">rf_default</a>(),
<a name="l00408"></a>00408                     <a class="code" href="namespacevigra.html#ae19ed2482e705ffa14000822902fc131" title="factory function to return a RF_DEFAULT tag">rf_default</a>(),
<a name="l00409"></a>00409                     rnd);
<a name="l00410"></a>00410     }
<a name="l00411"></a>00411 
<a name="l00412"></a>00412 <span class="comment"></span>
<a name="l00413"></a>00413 <span class="comment">    /**\name Learning</span>
<a name="l00414"></a>00414 <span class="comment">     * Following functions differ in the degree of customization</span>
<a name="l00415"></a>00415 <span class="comment">     * allowed</span>
<a name="l00416"></a>00416 <span class="comment">     */</span>
<a name="l00417"></a>00417     <span class="comment">/*\{*/</span><span class="comment"></span>
<a name="l00418"></a>00418 <span class="comment">    /**\brief learn on data with custom config and random number generator</span>
<a name="l00419"></a>00419 <span class="comment">     *</span>
<a name="l00420"></a>00420 <span class="comment">     * \param features  a N x M matrix containing N samples with M</span>
<a name="l00421"></a>00421 <span class="comment">     *                  features</span>
<a name="l00422"></a>00422 <span class="comment">     * \param response  a N x D matrix containing the corresponding</span>
<a name="l00423"></a>00423 <span class="comment">     *                  response. Current split functors assume D to</span>
<a name="l00424"></a>00424 <span class="comment">     *                  be 1 and ignore any additional columns.</span>
<a name="l00425"></a>00425 <span class="comment">     *                  This is not enforced to allow future support</span>
<a name="l00426"></a>00426 <span class="comment">     *                  for uncertain labels, label independent strata etc.</span>
<a name="l00427"></a>00427 <span class="comment">     *                  The Preprocessor specified during construction</span>
<a name="l00428"></a>00428 <span class="comment">     *                  should be able to handle features and labels</span>
<a name="l00429"></a>00429 <span class="comment">     *                  features and the labels.</span>
<a name="l00430"></a>00430 <span class="comment">     *                  see also: SplitFunctor, Preprocessing</span>
<a name="l00431"></a>00431 <span class="comment">     *</span>
<a name="l00432"></a>00432 <span class="comment">     * \param visitor   visitor which is to be applied after each split,</span>
<a name="l00433"></a>00433 <span class="comment">     *                  tree and at the end. Use rf_default() for using</span>
<a name="l00434"></a>00434 <span class="comment">     *                  default value. (No Visitors)</span>
<a name="l00435"></a>00435 <span class="comment">     *                  see also: rf::visitors</span>
<a name="l00436"></a>00436 <span class="comment">     * \param split     split functor to be used to calculate each split</span>
<a name="l00437"></a>00437 <span class="comment">     *                  use rf_default() for using default value. (GiniSplit)</span>
<a name="l00438"></a>00438 <span class="comment">     *                  see also:  rf::split </span>
<a name="l00439"></a>00439 <span class="comment">     * \param stop</span>
<a name="l00440"></a>00440 <span class="comment">     *                  predicate to be used to calculate each split</span>
<a name="l00441"></a>00441 <span class="comment">     *                  use rf_default() for using default value. (EarlyStoppStd)</span>
<a name="l00442"></a>00442 <span class="comment">     * \param random    RandomNumberGenerator to be used. Use</span>
<a name="l00443"></a>00443 <span class="comment">     *                  rf_default() to use default value.(RandomMT19337)</span>
<a name="l00444"></a>00444 <span class="comment">     *</span>
<a name="l00445"></a>00445 <span class="comment">     *</span>
<a name="l00446"></a>00446 <span class="comment">     */</span>
<a name="l00447"></a>00447     <span class="keyword">template</span> &lt;<span class="keyword">class </span>U, <span class="keyword">class </span>C1,
<a name="l00448"></a>00448              <span class="keyword">class </span>U2,<span class="keyword">class </span>C2,
<a name="l00449"></a>00449              <span class="keyword">class </span>Split_t,
<a name="l00450"></a>00450              <span class="keyword">class </span>Stop_t,
<a name="l00451"></a>00451              <span class="keyword">class </span>Visitor_t,
<a name="l00452"></a>00452              <span class="keyword">class </span>Random_t&gt;
<a name="l00453"></a>00453     <span class="keywordtype">void</span> <a class="code" href="group__MachineLearning.html#ga11157c680b4f47c5592d6695b5fbac05" title="learn on data with custom config and random number generator">learn</a>( MultiArrayView&lt;2, U, C1&gt; <span class="keyword">const</span>  &amp;   features,
<a name="l00454"></a>00454                 MultiArrayView&lt;2, U2,C2&gt; <span class="keyword">const</span>  &amp;   response,
<a name="l00455"></a>00455                 Visitor_t                           visitor,
<a name="l00456"></a>00456                 Split_t                             split,
<a name="l00457"></a>00457                 Stop_t                              stop,
<a name="l00458"></a>00458                 Random_t                 <span class="keyword">const</span>  &amp;   random);
<a name="l00459"></a>00459 
<a name="l00460"></a>00460     <span class="keyword">template</span> &lt;<span class="keyword">class </span>U, <span class="keyword">class </span>C1,
<a name="l00461"></a>00461              <span class="keyword">class </span>U2,<span class="keyword">class </span>C2,
<a name="l00462"></a>00462              <span class="keyword">class </span>Split_t,
<a name="l00463"></a>00463              <span class="keyword">class </span>Stop_t,
<a name="l00464"></a>00464              <span class="keyword">class </span>Visitor_t&gt;
<a name="l00465"></a>00465     <span class="keywordtype">void</span> <a class="code" href="group__MachineLearning.html#ga11157c680b4f47c5592d6695b5fbac05" title="learn on data with custom config and random number generator">learn</a>( MultiArrayView&lt;2, U, C1&gt; <span class="keyword">const</span>  &amp;   features,
<a name="l00466"></a>00466                 MultiArrayView&lt;2, U2,C2&gt; <span class="keyword">const</span>  &amp;   response,
<a name="l00467"></a>00467                 Visitor_t                           visitor,
<a name="l00468"></a>00468                 Split_t                             split,
<a name="l00469"></a>00469                 Stop_t                              stop)
<a name="l00470"></a>00470 
<a name="l00471"></a>00471     {
<a name="l00472"></a>00472         RandomNumberGenerator&lt;&gt; rnd = RandomNumberGenerator&lt;&gt;(RandomSeed);
<a name="l00473"></a>00473         <a class="code" href="group__MachineLearning.html#ga11157c680b4f47c5592d6695b5fbac05" title="learn on data with custom config and random number generator">learn</a>(  features, 
<a name="l00474"></a>00474                 response,
<a name="l00475"></a>00475                 visitor, 
<a name="l00476"></a>00476                 split, 
<a name="l00477"></a>00477                 stop,
<a name="l00478"></a>00478                 rnd);
<a name="l00479"></a>00479     }
<a name="l00480"></a>00480 
<a name="l00481"></a>00481     <span class="keyword">template</span> &lt;<span class="keyword">class</span> U, <span class="keyword">class</span> C1, <span class="keyword">class</span> U2,<span class="keyword">class</span> C2, <span class="keyword">class</span> Visitor_t&gt;
<a name="l00482"></a>00482     <span class="keywordtype">void</span> <a class="code" href="group__MachineLearning.html#ga11157c680b4f47c5592d6695b5fbac05" title="learn on data with custom config and random number generator">learn</a>( MultiArrayView&lt;2, U, C1&gt; <span class="keyword">const</span>  &amp; features,
<a name="l00483"></a>00483                 MultiArrayView&lt;2, U2,C2&gt; <span class="keyword">const</span>  &amp; labels,
<a name="l00484"></a>00484                 Visitor_t                         visitor)
<a name="l00485"></a>00485     {
<a name="l00486"></a>00486         <a class="code" href="group__MachineLearning.html#ga11157c680b4f47c5592d6695b5fbac05" title="learn on data with custom config and random number generator">learn</a>(  features, 
<a name="l00487"></a>00487                 labels, 
<a name="l00488"></a>00488                 visitor, 
<a name="l00489"></a>00489                 <a class="code" href="namespacevigra.html#ae19ed2482e705ffa14000822902fc131" title="factory function to return a RF_DEFAULT tag">rf_default</a>(), 
<a name="l00490"></a>00490                 <a class="code" href="namespacevigra.html#ae19ed2482e705ffa14000822902fc131" title="factory function to return a RF_DEFAULT tag">rf_default</a>());
<a name="l00491"></a>00491     }
<a name="l00492"></a>00492 
<a name="l00493"></a>00493     <span class="keyword">template</span> &lt;<span class="keyword">class </span>U, <span class="keyword">class </span>C1, <span class="keyword">class </span>U2,<span class="keyword">class </span>C2, 
<a name="l00494"></a>00494               <span class="keyword">class </span>Visitor_t, <span class="keyword">class </span>Split_t&gt;
<a name="l00495"></a>00495     <span class="keywordtype">void</span> <a class="code" href="group__MachineLearning.html#ga11157c680b4f47c5592d6695b5fbac05" title="learn on data with custom config and random number generator">learn</a>(   MultiArrayView&lt;2, U, C1&gt; <span class="keyword">const</span>  &amp; features,
<a name="l00496"></a>00496                   MultiArrayView&lt;2, U2,C2&gt; <span class="keyword">const</span>  &amp; labels,
<a name="l00497"></a>00497                   Visitor_t                         visitor,
<a name="l00498"></a>00498                   Split_t                           split)
<a name="l00499"></a>00499     {
<a name="l00500"></a>00500         <a class="code" href="group__MachineLearning.html#ga11157c680b4f47c5592d6695b5fbac05" title="learn on data with custom config and random number generator">learn</a>(  features, 
<a name="l00501"></a>00501                 labels, 
<a name="l00502"></a>00502                 visitor, 
<a name="l00503"></a>00503                 split, 
<a name="l00504"></a>00504                 <a class="code" href="namespacevigra.html#ae19ed2482e705ffa14000822902fc131" title="factory function to return a RF_DEFAULT tag">rf_default</a>());
<a name="l00505"></a>00505     }
<a name="l00506"></a>00506 <span class="comment"></span>
<a name="l00507"></a>00507 <span class="comment">    /**\brief learn on data with default configuration</span>
<a name="l00508"></a>00508 <span class="comment">     *</span>
<a name="l00509"></a>00509 <span class="comment">     * \param features  a N x M matrix containing N samples with M</span>
<a name="l00510"></a>00510 <span class="comment">     *                  features</span>
<a name="l00511"></a>00511 <span class="comment">     * \param labels    a N x D matrix containing the corresponding</span>
<a name="l00512"></a>00512 <span class="comment">     *                  N labels. Current split functors assume D to</span>
<a name="l00513"></a>00513 <span class="comment">     *                  be 1 and ignore any additional columns.</span>
<a name="l00514"></a>00514 <span class="comment">     *                  this is not enforced to allow future support</span>
<a name="l00515"></a>00515 <span class="comment">     *                  for uncertain labels.</span>
<a name="l00516"></a>00516 <span class="comment">     *</span>
<a name="l00517"></a>00517 <span class="comment">     * learning is done with:</span>
<a name="l00518"></a>00518 <span class="comment">     *</span>
<a name="l00519"></a>00519 <span class="comment">     * \sa rf::split, EarlyStoppStd</span>
<a name="l00520"></a>00520 <span class="comment">     *</span>
<a name="l00521"></a>00521 <span class="comment">     * - Randomly seeded random number generator</span>
<a name="l00522"></a>00522 <span class="comment">     * - default gini split functor as described by Breiman</span>
<a name="l00523"></a>00523 <span class="comment">     * - default The standard early stopping criterion</span>
<a name="l00524"></a>00524 <span class="comment">     */</span>
<a name="l00525"></a>00525     <span class="keyword">template</span> &lt;<span class="keyword">class</span> U, <span class="keyword">class</span> C1, <span class="keyword">class</span> U2,<span class="keyword">class</span> C2&gt;
<a name="l00526"></a><a class="code" href="group__MachineLearning.html#gae480948c60eee838463b03a4593ee507">00526</a>     <span class="keywordtype">void</span> <a class="code" href="group__MachineLearning.html#ga11157c680b4f47c5592d6695b5fbac05" title="learn on data with custom config and random number generator">learn</a>(   <a class="code" href="classvigra_1_1MultiArrayView.html" title="Base class for, and view to, vigra::MultiArray.">MultiArrayView&lt;2, U, C1&gt;</a> <span class="keyword">const</span>  &amp; features,
<a name="l00527"></a>00527                     <a class="code" href="classvigra_1_1MultiArrayView.html" title="Base class for, and view to, vigra::MultiArray.">MultiArrayView&lt;2, U2,C2&gt;</a> <span class="keyword">const</span>  &amp; labels)
<a name="l00528"></a>00528     {
<a name="l00529"></a>00529         <a class="code" href="group__MachineLearning.html#ga11157c680b4f47c5592d6695b5fbac05" title="learn on data with custom config and random number generator">learn</a>(  features, 
<a name="l00530"></a>00530                 labels, 
<a name="l00531"></a>00531                 <a class="code" href="namespacevigra.html#ae19ed2482e705ffa14000822902fc131" title="factory function to return a RF_DEFAULT tag">rf_default</a>(), 
<a name="l00532"></a>00532                 <a class="code" href="namespacevigra.html#ae19ed2482e705ffa14000822902fc131" title="factory function to return a RF_DEFAULT tag">rf_default</a>(), 
<a name="l00533"></a>00533                 <a class="code" href="namespacevigra.html#ae19ed2482e705ffa14000822902fc131" title="factory function to return a RF_DEFAULT tag">rf_default</a>());
<a name="l00534"></a>00534     }
<a name="l00535"></a>00535     <span class="comment">/*\}*/</span>
<a name="l00536"></a>00536 
<a name="l00537"></a>00537 
<a name="l00538"></a>00538 <span class="comment"></span>
<a name="l00539"></a>00539 <span class="comment">    /**\name prediction</span>
<a name="l00540"></a>00540 <span class="comment">     */</span>
<a name="l00541"></a>00541     <span class="comment">/*\{*/</span><span class="comment"></span>
<a name="l00542"></a>00542 <span class="comment">    /** \brief predict a label given a feature.</span>
<a name="l00543"></a>00543 <span class="comment">     *</span>
<a name="l00544"></a>00544 <span class="comment">     * \param features: a 1 by featureCount matrix containing</span>
<a name="l00545"></a>00545 <span class="comment">     *        data point to be predicted (this only works in</span>
<a name="l00546"></a>00546 <span class="comment">     *        classification setting)</span>
<a name="l00547"></a>00547 <span class="comment">     * \param stop: early stopping criterion</span>
<a name="l00548"></a>00548 <span class="comment">     * \return double value representing class. You can use the</span>
<a name="l00549"></a>00549 <span class="comment">     *         predictLabels() function together with the</span>
<a name="l00550"></a>00550 <span class="comment">     *         rf.external_parameter().class_type_ attribute</span>
<a name="l00551"></a>00551 <span class="comment">     *         to get back the same type used during learning. </span>
<a name="l00552"></a>00552 <span class="comment">     */</span>
<a name="l00553"></a>00553     <span class="keyword">template</span> &lt;<span class="keyword">class</span> U, <span class="keyword">class</span> C, <span class="keyword">class</span> Stop&gt;
<a name="l00554"></a>00554     LabelType <a class="code" href="group__MachineLearning.html#gaf79cd1eb1287d9d26dd90be5cb971645" title="predict a label given a feature.">predictLabel</a>(<a class="code" href="classvigra_1_1MultiArrayView.html" title="Base class for, and view to, vigra::MultiArray.">MultiArrayView&lt;2, U, C&gt;</a><span class="keyword">const</span> &amp; features, Stop &amp; stop) <span class="keyword">const</span>;
<a name="l00555"></a>00555 
<a name="l00556"></a>00556     <span class="keyword">template</span> &lt;<span class="keyword">class</span> U, <span class="keyword">class</span> C&gt;
<a name="l00557"></a>00557     LabelType <a class="code" href="group__MachineLearning.html#gaf79cd1eb1287d9d26dd90be5cb971645" title="predict a label given a feature.">predictLabel</a>(<a class="code" href="classvigra_1_1MultiArrayView.html" title="Base class for, and view to, vigra::MultiArray.">MultiArrayView&lt;2, U, C&gt;</a><span class="keyword">const</span> &amp; features)
<a name="l00558"></a>00558     {
<a name="l00559"></a>00559         <span class="keywordflow">return</span> <a class="code" href="group__MachineLearning.html#gaf79cd1eb1287d9d26dd90be5cb971645" title="predict a label given a feature.">predictLabel</a>(features, <a class="code" href="namespacevigra.html#ae19ed2482e705ffa14000822902fc131" title="factory function to return a RF_DEFAULT tag">rf_default</a>()); 
<a name="l00560"></a>00560     } <span class="comment"></span>
<a name="l00561"></a>00561 <span class="comment">    /** \brief predict a label with features and class priors</span>
<a name="l00562"></a>00562 <span class="comment">     *</span>
<a name="l00563"></a>00563 <span class="comment">     * \param features: same as above.</span>
<a name="l00564"></a>00564 <span class="comment">     * \param prior:   iterator to prior weighting of classes</span>
<a name="l00565"></a>00565 <span class="comment">     * \return sam as above.</span>
<a name="l00566"></a>00566 <span class="comment">     */</span>
<a name="l00567"></a>00567     <span class="keyword">template</span> &lt;<span class="keyword">class</span> U, <span class="keyword">class</span> C&gt;
<a name="l00568"></a>00568     LabelType <a class="code" href="group__MachineLearning.html#gaf79cd1eb1287d9d26dd90be5cb971645" title="predict a label given a feature.">predictLabel</a>(MultiArrayView&lt;2, U, C&gt; <span class="keyword">const</span> &amp; features,
<a name="l00569"></a>00569                                 ArrayVectorView&lt;double&gt; prior) <span class="keyword">const</span>;
<a name="l00570"></a>00570 <span class="comment"></span>
<a name="l00571"></a>00571 <span class="comment">    /** \brief predict multiple labels with given features</span>
<a name="l00572"></a>00572 <span class="comment">     *</span>
<a name="l00573"></a>00573 <span class="comment">     * \param features: a n by featureCount matrix containing</span>
<a name="l00574"></a>00574 <span class="comment">     *        data point to be predicted (this only works in</span>
<a name="l00575"></a>00575 <span class="comment">     *        classification setting)</span>
<a name="l00576"></a>00576 <span class="comment">     * \param labels: a n by 1 matrix passed by reference to store</span>
<a name="l00577"></a>00577 <span class="comment">     *        output.</span>
<a name="l00578"></a>00578 <span class="comment">     *</span>
<a name="l00579"></a>00579 <span class="comment">     * If the input contains an NaN value, an precondition exception is thrown.</span>
<a name="l00580"></a>00580 <span class="comment">     */</span>
<a name="l00581"></a>00581     <span class="keyword">template</span> &lt;<span class="keyword">class</span> U, <span class="keyword">class</span> C1, <span class="keyword">class</span> T, <span class="keyword">class</span> C2&gt;
<a name="l00582"></a><a class="code" href="group__MachineLearning.html#gaa2a5fc3a96d247c319c27c5bde7fab4e">00582</a>     <span class="keywordtype">void</span> <a class="code" href="group__MachineLearning.html#gaa2a5fc3a96d247c319c27c5bde7fab4e" title="predict multiple labels with given features">predictLabels</a>(<a class="code" href="classvigra_1_1MultiArrayView.html" title="Base class for, and view to, vigra::MultiArray.">MultiArrayView&lt;2, U, C1&gt;</a><span class="keyword">const</span> &amp; features,
<a name="l00583"></a>00583                        <a class="code" href="classvigra_1_1MultiArrayView.html">MultiArrayView&lt;2, T, C2&gt;</a> &amp; labels)<span class="keyword"> const</span>
<a name="l00584"></a>00584 <span class="keyword">    </span>{
<a name="l00585"></a>00585         vigra_precondition(features.<a class="code" href="classvigra_1_1MultiArrayView.html#a53c8f0d5c70f10f31fbc246cbe524e32">shape</a>(0) == labels.<a class="code" href="classvigra_1_1MultiArrayView.html#a53c8f0d5c70f10f31fbc246cbe524e32">shape</a>(0),
<a name="l00586"></a>00586             <span class="stringliteral">&quot;RandomForest::predictLabels(): Label array has wrong size.&quot;</span>);
<a name="l00587"></a>00587         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> k=0; k&lt;features.<a class="code" href="classvigra_1_1MultiArrayView.html#a53c8f0d5c70f10f31fbc246cbe524e32">shape</a>(0); ++k)
<a name="l00588"></a>00588         {
<a name="l00589"></a>00589             vigra_precondition(!detail::contains_nan(<a class="code" href="group__LinearAlgebraFunctions.html#ga8cc5e13ed0643c0d9b8c9021eaae625d">rowVector</a>(features, k)),
<a name="l00590"></a>00590                 <span class="stringliteral">&quot;RandomForest::predictLabels(): NaN in feature matrix.&quot;</span>);
<a name="l00591"></a>00591             labels(k,0) = detail::RequiresExplicitCast&lt;T&gt;::cast(<a class="code" href="group__MachineLearning.html#gaf79cd1eb1287d9d26dd90be5cb971645" title="predict a label given a feature.">predictLabel</a>(<a class="code" href="group__LinearAlgebraFunctions.html#ga8cc5e13ed0643c0d9b8c9021eaae625d">rowVector</a>(features, k), <a class="code" href="namespacevigra.html#ae19ed2482e705ffa14000822902fc131" title="factory function to return a RF_DEFAULT tag">rf_default</a>()));
<a name="l00592"></a>00592         }
<a name="l00593"></a>00593     }
<a name="l00594"></a>00594 <span class="comment"></span>
<a name="l00595"></a>00595 <span class="comment">    /** \brief predict multiple labels with given features</span>
<a name="l00596"></a>00596 <span class="comment">     *</span>
<a name="l00597"></a>00597 <span class="comment">     * \param features: a n by featureCount matrix containing</span>
<a name="l00598"></a>00598 <span class="comment">     *        data point to be predicted (this only works in</span>
<a name="l00599"></a>00599 <span class="comment">     *        classification setting)</span>
<a name="l00600"></a>00600 <span class="comment">     * \param labels: a n by 1 matrix passed by reference to store</span>
<a name="l00601"></a>00601 <span class="comment">     *        output.</span>
<a name="l00602"></a>00602 <span class="comment">     * \param nanLabel: label to be returned for the row of the input that</span>
<a name="l00603"></a>00603 <span class="comment">     *        contain an NaN value.</span>
<a name="l00604"></a>00604 <span class="comment">     */</span>
<a name="l00605"></a>00605     <span class="keyword">template</span> &lt;<span class="keyword">class</span> U, <span class="keyword">class</span> C1, <span class="keyword">class</span> T, <span class="keyword">class</span> C2&gt;
<a name="l00606"></a><a class="code" href="group__MachineLearning.html#ga3f2129f1cac1e9f3b0d5ef78fc81460c">00606</a>     <span class="keywordtype">void</span> <a class="code" href="group__MachineLearning.html#gaa2a5fc3a96d247c319c27c5bde7fab4e" title="predict multiple labels with given features">predictLabels</a>(<a class="code" href="classvigra_1_1MultiArrayView.html" title="Base class for, and view to, vigra::MultiArray.">MultiArrayView&lt;2, U, C1&gt;</a><span class="keyword">const</span> &amp; features,
<a name="l00607"></a>00607                        <a class="code" href="classvigra_1_1MultiArrayView.html">MultiArrayView&lt;2, T, C2&gt;</a> &amp; labels,
<a name="l00608"></a>00608                        LabelType nanLabel)<span class="keyword"> const</span>
<a name="l00609"></a>00609 <span class="keyword">    </span>{
<a name="l00610"></a>00610         vigra_precondition(features.<a class="code" href="classvigra_1_1MultiArrayView.html#a53c8f0d5c70f10f31fbc246cbe524e32">shape</a>(0) == labels.<a class="code" href="classvigra_1_1MultiArrayView.html#a53c8f0d5c70f10f31fbc246cbe524e32">shape</a>(0),
<a name="l00611"></a>00611             <span class="stringliteral">&quot;RandomForest::predictLabels(): Label array has wrong size.&quot;</span>);
<a name="l00612"></a>00612         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> k=0; k&lt;features.<a class="code" href="classvigra_1_1MultiArrayView.html#a53c8f0d5c70f10f31fbc246cbe524e32">shape</a>(0); ++k)
<a name="l00613"></a>00613         {
<a name="l00614"></a>00614             <span class="keywordflow">if</span>(detail::contains_nan(<a class="code" href="group__LinearAlgebraFunctions.html#ga8cc5e13ed0643c0d9b8c9021eaae625d">rowVector</a>(features, k)))
<a name="l00615"></a>00615                 labels(k,0) = nanLabel;
<a name="l00616"></a>00616             <span class="keywordflow">else</span>
<a name="l00617"></a>00617                 labels(k,0) = detail::RequiresExplicitCast&lt;T&gt;::cast(<a class="code" href="group__MachineLearning.html#gaf79cd1eb1287d9d26dd90be5cb971645" title="predict a label given a feature.">predictLabel</a>(<a class="code" href="group__LinearAlgebraFunctions.html#ga8cc5e13ed0643c0d9b8c9021eaae625d">rowVector</a>(features, k), <a class="code" href="namespacevigra.html#ae19ed2482e705ffa14000822902fc131" title="factory function to return a RF_DEFAULT tag">rf_default</a>()));
<a name="l00618"></a>00618         }
<a name="l00619"></a>00619     }
<a name="l00620"></a>00620 <span class="comment"></span>
<a name="l00621"></a>00621 <span class="comment">    /** \brief predict multiple labels with given features</span>
<a name="l00622"></a>00622 <span class="comment">     *</span>
<a name="l00623"></a>00623 <span class="comment">     * \param features: a n by featureCount matrix containing</span>
<a name="l00624"></a>00624 <span class="comment">     *        data point to be predicted (this only works in</span>
<a name="l00625"></a>00625 <span class="comment">     *        classification setting)</span>
<a name="l00626"></a>00626 <span class="comment">     * \param labels: a n by 1 matrix passed by reference to store</span>
<a name="l00627"></a>00627 <span class="comment">     *        output.</span>
<a name="l00628"></a>00628 <span class="comment">     * \param stop: an early stopping criterion.</span>
<a name="l00629"></a>00629 <span class="comment">     */</span>
<a name="l00630"></a>00630     <span class="keyword">template</span> &lt;<span class="keyword">class</span> U, <span class="keyword">class</span> C1, <span class="keyword">class</span> T, <span class="keyword">class</span> C2, <span class="keyword">class</span> Stop&gt;
<a name="l00631"></a><a class="code" href="group__MachineLearning.html#ga20542164f24478948190079e3ba311b2">00631</a>     <span class="keywordtype">void</span> <a class="code" href="group__MachineLearning.html#gaa2a5fc3a96d247c319c27c5bde7fab4e" title="predict multiple labels with given features">predictLabels</a>(<a class="code" href="classvigra_1_1MultiArrayView.html" title="Base class for, and view to, vigra::MultiArray.">MultiArrayView&lt;2, U, C1&gt;</a><span class="keyword">const</span> &amp; features,
<a name="l00632"></a>00632                        <a class="code" href="classvigra_1_1MultiArrayView.html">MultiArrayView&lt;2, T, C2&gt;</a> &amp; labels,
<a name="l00633"></a>00633                        Stop                     &amp; stop)<span class="keyword"> const</span>
<a name="l00634"></a>00634 <span class="keyword">    </span>{
<a name="l00635"></a>00635         vigra_precondition(features.<a class="code" href="classvigra_1_1MultiArrayView.html#a53c8f0d5c70f10f31fbc246cbe524e32">shape</a>(0) == labels.<a class="code" href="classvigra_1_1MultiArrayView.html#a53c8f0d5c70f10f31fbc246cbe524e32">shape</a>(0),
<a name="l00636"></a>00636             <span class="stringliteral">&quot;RandomForest::predictLabels(): Label array has wrong size.&quot;</span>);
<a name="l00637"></a>00637         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> k=0; k&lt;features.<a class="code" href="classvigra_1_1MultiArrayView.html#a53c8f0d5c70f10f31fbc246cbe524e32">shape</a>(0); ++k)
<a name="l00638"></a>00638             labels(k,0) = detail::RequiresExplicitCast&lt;T&gt;::cast(<a class="code" href="group__MachineLearning.html#gaf79cd1eb1287d9d26dd90be5cb971645" title="predict a label given a feature.">predictLabel</a>(<a class="code" href="group__LinearAlgebraFunctions.html#ga8cc5e13ed0643c0d9b8c9021eaae625d">rowVector</a>(features, k), stop));
<a name="l00639"></a>00639     }<span class="comment"></span>
<a name="l00640"></a>00640 <span class="comment">    /** \brief predict the class probabilities for multiple labels</span>
<a name="l00641"></a>00641 <span class="comment">     *</span>
<a name="l00642"></a>00642 <span class="comment">     *  \param features same as above</span>
<a name="l00643"></a>00643 <span class="comment">     *  \param prob a n x class_count_ matrix. passed by reference to</span>
<a name="l00644"></a>00644 <span class="comment">     *  save class probabilities</span>
<a name="l00645"></a>00645 <span class="comment">     *  \param stop earlystopping criterion</span>
<a name="l00646"></a>00646 <span class="comment">     *  \sa EarlyStopping</span>
<a name="l00647"></a>00647 <span class="comment">     </span>
<a name="l00648"></a>00648 <span class="comment">        When a row of the feature array contains an NaN, the corresponding instance</span>
<a name="l00649"></a>00649 <span class="comment">        cannot belong to any of the classes. The corresponding row in the probability </span>
<a name="l00650"></a>00650 <span class="comment">        array will therefore contain all zeros.</span>
<a name="l00651"></a>00651 <span class="comment">     */</span>
<a name="l00652"></a>00652     <span class="keyword">template</span> &lt;<span class="keyword">class</span> U, <span class="keyword">class</span> C1, <span class="keyword">class</span> T, <span class="keyword">class</span> C2, <span class="keyword">class</span> Stop&gt;
<a name="l00653"></a>00653     <span class="keywordtype">void</span> <a class="code" href="group__MachineLearning.html#ga30e310de1642021af2e24d56be57a37d" title="predict the class probabilities for multiple labels">predictProbabilities</a>(<a class="code" href="classvigra_1_1MultiArrayView.html" title="Base class for, and view to, vigra::MultiArray.">MultiArrayView&lt;2, U, C1&gt;</a><span class="keyword">const</span> &amp;   features,
<a name="l00654"></a>00654                               <a class="code" href="classvigra_1_1MultiArrayView.html">MultiArrayView&lt;2, T, C2&gt;</a> &amp;        prob,
<a name="l00655"></a>00655                               Stop                     &amp;        stop) <span class="keyword">const</span>;
<a name="l00656"></a>00656     <span class="keyword">template</span> &lt;<span class="keyword">class</span> T1,<span class="keyword">class</span> T2, <span class="keyword">class</span> C&gt;
<a name="l00657"></a>00657     <span class="keywordtype">void</span> <a class="code" href="group__MachineLearning.html#ga30e310de1642021af2e24d56be57a37d" title="predict the class probabilities for multiple labels">predictProbabilities</a>(OnlinePredictionSet&lt;T1&gt; &amp;  predictionSet,
<a name="l00658"></a>00658                                <a class="code" href="classvigra_1_1MultiArrayView.html" title="Base class for, and view to, vigra::MultiArray.">MultiArrayView&lt;2, T2, C&gt;</a> &amp;       prob);
<a name="l00659"></a>00659 <span class="comment"></span>
<a name="l00660"></a>00660 <span class="comment">    /** \brief predict the class probabilities for multiple labels</span>
<a name="l00661"></a>00661 <span class="comment">     *</span>
<a name="l00662"></a>00662 <span class="comment">     *  \param features same as above</span>
<a name="l00663"></a>00663 <span class="comment">     *  \param prob a n x class_count_ matrix. passed by reference to</span>
<a name="l00664"></a>00664 <span class="comment">     *  save class probabilities</span>
<a name="l00665"></a>00665 <span class="comment">     */</span>
<a name="l00666"></a>00666     <span class="keyword">template</span> &lt;<span class="keyword">class</span> U, <span class="keyword">class</span> C1, <span class="keyword">class</span> T, <span class="keyword">class</span> C2&gt;
<a name="l00667"></a><a class="code" href="group__MachineLearning.html#gaf3fb598fb45d272f6f6745321cbc8b81">00667</a>     <span class="keywordtype">void</span> <a class="code" href="group__MachineLearning.html#ga30e310de1642021af2e24d56be57a37d" title="predict the class probabilities for multiple labels">predictProbabilities</a>(<a class="code" href="classvigra_1_1MultiArrayView.html" title="Base class for, and view to, vigra::MultiArray.">MultiArrayView&lt;2, U, C1&gt;</a><span class="keyword">const</span> &amp;   features,
<a name="l00668"></a>00668                               <a class="code" href="classvigra_1_1MultiArrayView.html">MultiArrayView&lt;2, T, C2&gt;</a> &amp;        prob)<span class="keyword">  const</span>
<a name="l00669"></a>00669 <span class="keyword">    </span>{
<a name="l00670"></a>00670         <a class="code" href="group__MachineLearning.html#ga30e310de1642021af2e24d56be57a37d" title="predict the class probabilities for multiple labels">predictProbabilities</a>(features, prob, <a class="code" href="namespacevigra.html#ae19ed2482e705ffa14000822902fc131" title="factory function to return a RF_DEFAULT tag">rf_default</a>()); 
<a name="l00671"></a>00671     }   
<a name="l00672"></a>00672 
<a name="l00673"></a>00673     <span class="keyword">template</span> &lt;<span class="keyword">class</span> U, <span class="keyword">class</span> C1, <span class="keyword">class</span> T, <span class="keyword">class</span> C2&gt;
<a name="l00674"></a>00674     <span class="keywordtype">void</span> predictRaw(<a class="code" href="classvigra_1_1MultiArrayView.html" title="Base class for, and view to, vigra::MultiArray.">MultiArrayView&lt;2, U, C1&gt;</a><span class="keyword">const</span> &amp;   features,
<a name="l00675"></a>00675                     <a class="code" href="classvigra_1_1MultiArrayView.html">MultiArrayView&lt;2, T, C2&gt;</a> &amp;        prob)  <span class="keyword">const</span>;
<a name="l00676"></a>00676 
<a name="l00677"></a>00677 
<a name="l00678"></a>00678     <span class="comment">/*\}*/</span>
<a name="l00679"></a>00679 
<a name="l00680"></a>00680 };
<a name="l00681"></a>00681 
<a name="l00682"></a>00682 
<a name="l00683"></a>00683 <span class="keyword">template</span> &lt;<span class="keyword">class</span> LabelType, <span class="keyword">class</span> PreprocessorTag&gt;
<a name="l00684"></a>00684 <span class="keyword">template</span>&lt;<span class="keyword">class </span>U,<span class="keyword">class </span>C1,
<a name="l00685"></a>00685     <span class="keyword">class </span>U2, <span class="keyword">class </span>C2,
<a name="l00686"></a>00686     <span class="keyword">class </span>Split_t,
<a name="l00687"></a>00687     <span class="keyword">class </span>Stop_t,
<a name="l00688"></a>00688     <span class="keyword">class </span>Visitor_t,
<a name="l00689"></a>00689     <span class="keyword">class </span>Random_t&gt;
<a name="l00690"></a>00690 <span class="keywordtype">void</span> RandomForest&lt;LabelType, PreprocessorTag&gt;::onlineLearn(MultiArrayView&lt;2,U,C1&gt; <span class="keyword">const</span> &amp; features,
<a name="l00691"></a>00691                                                              MultiArrayView&lt;2,U2,C2&gt; <span class="keyword">const</span> &amp; response,
<a name="l00692"></a>00692                                                              <span class="keywordtype">int</span> new_start_index,
<a name="l00693"></a>00693                                                              Visitor_t visitor_,
<a name="l00694"></a>00694                                                              Split_t split_,
<a name="l00695"></a>00695                                                              Stop_t stop_,
<a name="l00696"></a>00696                                                              Random_t &amp; random,
<a name="l00697"></a>00697                                                              <span class="keywordtype">bool</span> adjust_thresholds)
<a name="l00698"></a>00698 {
<a name="l00699"></a>00699     online_visitor_.activate();
<a name="l00700"></a>00700     online_visitor_.adjust_thresholds=adjust_thresholds;
<a name="l00701"></a>00701 
<a name="l00702"></a>00702     <span class="keyword">using namespace </span>rf;
<a name="l00703"></a>00703     <span class="comment">//typedefs</span>
<a name="l00704"></a>00704     <span class="keyword">typedef</span> Processor&lt;PreprocessorTag,LabelType,U,C1,U2,C2&gt; Preprocessor_t;
<a name="l00705"></a>00705     <span class="keyword">typedef</span>          UniformIntRandomFunctor&lt;Random_t&gt;
<a name="l00706"></a>00706                                                     RandFunctor_t;
<a name="l00707"></a>00707     <span class="comment">// default values and initialization</span>
<a name="l00708"></a>00708     <span class="comment">// Value Chooser chooses second argument as value if first argument</span>
<a name="l00709"></a>00709     <span class="comment">// is of type RF_DEFAULT. (thanks to template magic - don&#39;t care about</span>
<a name="l00710"></a>00710     <span class="comment">// it - just smile and wave.</span>
<a name="l00711"></a>00711     
<a name="l00712"></a>00712 <span class="preprocessor">    #define RF_CHOOSER(type_) detail::Value_Chooser&lt;type_, Default_##type_&gt; </span>
<a name="l00713"></a>00713 <span class="preprocessor"></span>    Default_Stop_t default_stop(options_);
<a name="l00714"></a>00714     <span class="keyword">typename</span> RF_CHOOSER(Stop_t)::type stop
<a name="l00715"></a>00715             = RF_CHOOSER(Stop_t)::choose(stop_, default_stop); 
<a name="l00716"></a>00716     Default_Split_t default_split;
<a name="l00717"></a>00717     <span class="keyword">typename</span> RF_CHOOSER(Split_t)::type split 
<a name="l00718"></a>00718             = RF_CHOOSER(Split_t)::choose(split_, default_split); 
<a name="l00719"></a>00719     rf::visitors::StopVisiting stopvisiting;
<a name="l00720"></a>00720     <span class="keyword">typedef</span>  rf::visitors::detail::VisitorNode
<a name="l00721"></a>00721                 &lt;rf::visitors::OnlineLearnVisitor, 
<a name="l00722"></a>00722                  <span class="keyword">typename</span> RF_CHOOSER(Visitor_t)::type&gt; 
<a name="l00723"></a>00723                                                         IntermedVis; 
<a name="l00724"></a>00724     IntermedVis
<a name="l00725"></a>00725         visitor(online_visitor_, RF_CHOOSER(Visitor_t)::choose(visitor_, stopvisiting));
<a name="l00726"></a>00726 <span class="preprocessor">    #undef RF_CHOOSER</span>
<a name="l00727"></a>00727 <span class="preprocessor"></span>
<a name="l00728"></a>00728     <span class="comment">// Preprocess the data to get something the split functor can work</span>
<a name="l00729"></a>00729     <span class="comment">// with. Also fill the ext_param structure by preprocessing</span>
<a name="l00730"></a>00730     <span class="comment">// option parameters that could only be completely evaluated</span>
<a name="l00731"></a>00731     <span class="comment">// when the training data is known.</span>
<a name="l00732"></a>00732     ext_param_.class_count_=0;
<a name="l00733"></a>00733     Preprocessor_t preprocessor(    features, response,
<a name="l00734"></a>00734                                     options_, ext_param_);
<a name="l00735"></a>00735 
<a name="l00736"></a>00736     <span class="comment">// Make stl compatible random functor.</span>
<a name="l00737"></a>00737     RandFunctor_t           randint     ( random);
<a name="l00738"></a>00738 
<a name="l00739"></a>00739     <span class="comment">// Give the Split functor information about the data.</span>
<a name="l00740"></a>00740     split.set_external_parameters(ext_param_);
<a name="l00741"></a>00741     stop.set_external_parameters(ext_param_);
<a name="l00742"></a>00742 
<a name="l00743"></a>00743 
<a name="l00744"></a>00744     <span class="comment">//Create poisson samples</span>
<a name="l00745"></a>00745     PoissonSampler&lt;RandomTT800&gt; poisson_sampler(1.0,<a class="code" href="group__FixedSizeInt.html#ga92f05c4b6944ec5926841e34f03a9060" title="32-bit signed int">vigra::Int32</a>(new_start_index),<a class="code" href="group__FixedSizeInt.html#ga92f05c4b6944ec5926841e34f03a9060" title="32-bit signed int">vigra::Int32</a>(ext_param().row_count_));
<a name="l00746"></a>00746 
<a name="l00747"></a>00747     <span class="comment">//TODO: visitors for online learning</span>
<a name="l00748"></a>00748     <span class="comment">//visitor.visit_at_beginning(*this, preprocessor);</span>
<a name="l00749"></a>00749 
<a name="l00750"></a>00750     <span class="comment">// THE MAIN EFFING RF LOOP - YEAY DUDE!</span>
<a name="l00751"></a>00751     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ii = 0; ii &lt; (int)trees_.size(); ++ii)
<a name="l00752"></a>00752     {
<a name="l00753"></a>00753         online_visitor_.tree_id=ii;
<a name="l00754"></a>00754         poisson_sampler.sample();
<a name="l00755"></a>00755         std::map&lt;int,int&gt; leaf_parents;
<a name="l00756"></a>00756         leaf_parents.clear();
<a name="l00757"></a>00757         <span class="comment">//Get all the leaf nodes for that sample</span>
<a name="l00758"></a>00758         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> s=0;s&lt;poisson_sampler.numOfSamples();++s)
<a name="l00759"></a>00759         {
<a name="l00760"></a>00760             <span class="keywordtype">int</span> sample=poisson_sampler[s];
<a name="l00761"></a>00761             online_visitor_.current_label=preprocessor.response()(sample,0);
<a name="l00762"></a>00762             online_visitor_.last_node_id=StackEntry_t::DecisionTreeNoParent;
<a name="l00763"></a>00763             <span class="keywordtype">int</span> leaf=trees_[ii].getToLeaf(<a class="code" href="group__LinearAlgebraFunctions.html#ga8cc5e13ed0643c0d9b8c9021eaae625d">rowVector</a>(features,sample),online_visitor_);
<a name="l00764"></a>00764 
<a name="l00765"></a>00765 
<a name="l00766"></a>00766             <span class="comment">//Add to the list for that leaf</span>
<a name="l00767"></a>00767             online_visitor_.add_to_index_list(ii,leaf,sample);
<a name="l00768"></a>00768             <span class="comment">//TODO: Class count?</span>
<a name="l00769"></a>00769             <span class="comment">//Store parent</span>
<a name="l00770"></a>00770             <span class="keywordflow">if</span>(Node&lt;e_ConstProbNode&gt;(trees_[ii].topology_,trees_[ii].parameters_,leaf).prob_begin()[preprocessor.response()(sample,0)]!=1.0)
<a name="l00771"></a>00771             {
<a name="l00772"></a>00772                 leaf_parents[leaf]=online_visitor_.last_node_id;
<a name="l00773"></a>00773             }
<a name="l00774"></a>00774         }
<a name="l00775"></a>00775 
<a name="l00776"></a>00776 
<a name="l00777"></a>00777         std::map&lt;int,int&gt;::iterator leaf_iterator;
<a name="l00778"></a>00778         <span class="keywordflow">for</span>(leaf_iterator=leaf_parents.begin();leaf_iterator!=leaf_parents.end();++leaf_iterator)
<a name="l00779"></a>00779         {
<a name="l00780"></a>00780             <span class="keywordtype">int</span> leaf=leaf_iterator-&gt;first;
<a name="l00781"></a>00781             <span class="keywordtype">int</span> parent=leaf_iterator-&gt;second;
<a name="l00782"></a>00782             <span class="keywordtype">int</span> lin_index=online_visitor_.trees_online_information[ii].exterior_to_index[leaf];
<a name="l00783"></a>00783             ArrayVector&lt;Int32&gt; indeces;
<a name="l00784"></a>00784             indeces.clear();
<a name="l00785"></a>00785             indeces.swap(online_visitor_.trees_online_information[ii].index_lists[lin_index]);
<a name="l00786"></a>00786             StackEntry_t stack_entry(indeces.begin(),
<a name="l00787"></a>00787                                      indeces.end(),
<a name="l00788"></a>00788                                      ext_param_.class_count_);
<a name="l00789"></a>00789 
<a name="l00790"></a>00790 
<a name="l00791"></a>00791             <span class="keywordflow">if</span>(parent!=-1)
<a name="l00792"></a>00792             {
<a name="l00793"></a>00793                 <span class="keywordflow">if</span>(NodeBase(trees_[ii].topology_,trees_[ii].parameters_,parent).child(0)==leaf)
<a name="l00794"></a>00794                 {
<a name="l00795"></a>00795                     stack_entry.leftParent=parent;
<a name="l00796"></a>00796                 }
<a name="l00797"></a>00797                 <span class="keywordflow">else</span>
<a name="l00798"></a>00798                 {
<a name="l00799"></a>00799                     vigra_assert(NodeBase(trees_[ii].topology_,trees_[ii].parameters_,parent).child(1)==leaf,<span class="stringliteral">&quot;last_node_id seems to be wrong&quot;</span>);
<a name="l00800"></a>00800                     stack_entry.rightParent=parent;
<a name="l00801"></a>00801                 }
<a name="l00802"></a>00802             }
<a name="l00803"></a>00803             <span class="comment">//trees_[ii].continueLearn(preprocessor.features(),preprocessor.response(),stack_entry,split,stop,visitor,randint,leaf);</span>
<a name="l00804"></a>00804             trees_[ii].continueLearn(preprocessor.features(),preprocessor.response(),stack_entry,split,stop,visitor,randint,-1);
<a name="l00805"></a>00805             <span class="comment">//Now, the last one moved onto leaf</span>
<a name="l00806"></a>00806             online_visitor_.move_exterior_node(ii,trees_[ii].topology_.size(),ii,leaf);
<a name="l00807"></a>00807             <span class="comment">//Now it should be classified correctly!</span>
<a name="l00808"></a>00808         }
<a name="l00809"></a>00809 
<a name="l00810"></a>00810         <span class="comment">/*visitor</span>
<a name="l00811"></a>00811 <span class="comment">            .visit_after_tree(  *this,</span>
<a name="l00812"></a>00812 <span class="comment">                                preprocessor,</span>
<a name="l00813"></a>00813 <span class="comment">                                poisson_sampler,</span>
<a name="l00814"></a>00814 <span class="comment">                                stack_entry,</span>
<a name="l00815"></a>00815 <span class="comment">                                ii);*/</span>
<a name="l00816"></a>00816     }
<a name="l00817"></a>00817 
<a name="l00818"></a>00818     <span class="comment">//visitor.visit_at_end(*this, preprocessor);</span>
<a name="l00819"></a>00819     online_visitor_.deactivate();
<a name="l00820"></a>00820 }
<a name="l00821"></a>00821 
<a name="l00822"></a>00822 <span class="keyword">template</span>&lt;<span class="keyword">class</span> LabelType, <span class="keyword">class</span> PreprocessorTag&gt;
<a name="l00823"></a>00823 <span class="keyword">template</span>&lt;<span class="keyword">class </span>U,<span class="keyword">class </span>C1,
<a name="l00824"></a>00824     <span class="keyword">class </span>U2, <span class="keyword">class </span>C2,
<a name="l00825"></a>00825     <span class="keyword">class </span>Split_t,
<a name="l00826"></a>00826     <span class="keyword">class </span>Stop_t,
<a name="l00827"></a>00827     <span class="keyword">class </span>Visitor_t,
<a name="l00828"></a>00828     <span class="keyword">class </span>Random_t&gt;
<a name="l00829"></a><a class="code" href="group__MachineLearning.html#gae1ccc1e1d0b2d4aaec94005e775b4db2">00829</a> <span class="keywordtype">void</span> <a class="code" href="group__MachineLearning.html#gae1ccc1e1d0b2d4aaec94005e775b4db2">RandomForest&lt;LabelType, PreprocessorTag&gt;::reLearnTree</a>(<a class="code" href="classvigra_1_1MultiArrayView.html" title="Base class for, and view to, vigra::MultiArray.">MultiArrayView&lt;2,U,C1&gt;</a> <span class="keyword">const</span> &amp; features,
<a name="l00830"></a>00830                  <a class="code" href="classvigra_1_1MultiArrayView.html" title="Base class for, and view to, vigra::MultiArray.">MultiArrayView&lt;2,U2,C2&gt;</a> <span class="keyword">const</span> &amp; response,
<a name="l00831"></a>00831                  <span class="keywordtype">int</span> treeId,
<a name="l00832"></a>00832                  Visitor_t visitor_,
<a name="l00833"></a>00833                  Split_t split_,
<a name="l00834"></a>00834                  Stop_t stop_,
<a name="l00835"></a>00835                  Random_t &amp; random)
<a name="l00836"></a>00836 {
<a name="l00837"></a>00837     <span class="keyword">using namespace </span>rf;
<a name="l00838"></a>00838     
<a name="l00839"></a>00839     
<a name="l00840"></a>00840     <span class="keyword">typedef</span>          <a class="code" href="classvigra_1_1UniformIntRandomFunctor.html">UniformIntRandomFunctor&lt;Random_t&gt;</a>
<a name="l00841"></a>00841                                                     RandFunctor_t;
<a name="l00842"></a>00842 
<a name="l00843"></a>00843     <span class="comment">// See rf_preprocessing.hxx for more info on this</span>
<a name="l00844"></a>00844     ext_param_.class_count_=0;
<a name="l00845"></a>00845     <span class="keyword">typedef</span> Processor&lt;PreprocessorTag,LabelType, U, C1, U2, C2&gt; Preprocessor_t;
<a name="l00846"></a>00846     
<a name="l00847"></a>00847     <span class="comment">// default values and initialization</span>
<a name="l00848"></a>00848     <span class="comment">// Value Chooser chooses second argument as value if first argument</span>
<a name="l00849"></a>00849     <span class="comment">// is of type RF_DEFAULT. (thanks to template magic - don&#39;t care about</span>
<a name="l00850"></a>00850     <span class="comment">// it - just smile and wave.</span>
<a name="l00851"></a>00851     
<a name="l00852"></a>00852 <span class="preprocessor">    #define RF_CHOOSER(type_) detail::Value_Chooser&lt;type_, Default_##type_&gt; </span>
<a name="l00853"></a>00853 <span class="preprocessor"></span>    <a class="code" href="classvigra_1_1EarlyStoppStd.html" title="Standard early stopping criterion.">Default_Stop_t</a> default_stop(options_);
<a name="l00854"></a>00854     <span class="keyword">typename</span> RF_CHOOSER(Stop_t)::type stop
<a name="l00855"></a>00855             = RF_CHOOSER(Stop_t)::choose(stop_, default_stop); 
<a name="l00856"></a>00856     <a class="code" href="classvigra_1_1ThresholdSplit.html">Default_Split_t</a> default_split;
<a name="l00857"></a>00857     <span class="keyword">typename</span> RF_CHOOSER(Split_t)::type split 
<a name="l00858"></a>00858             = RF_CHOOSER(Split_t)::choose(split_, default_split); 
<a name="l00859"></a>00859     <a class="code" href="classvigra_1_1rf_1_1visitors_1_1StopVisiting.html">rf::visitors::StopVisiting</a> stopvisiting;
<a name="l00860"></a>00860     <span class="keyword">typedef</span>  <a class="code" href="classvigra_1_1rf_1_1visitors_1_1detail_1_1VisitorNode.html">rf::visitors::detail::VisitorNode</a>
<a name="l00861"></a>00861                 &lt;<a class="code" href="classvigra_1_1rf_1_1visitors_1_1OnlineLearnVisitor.html">rf::visitors::OnlineLearnVisitor</a>, 
<a name="l00862"></a>00862                 <span class="keyword">typename</span> RF_CHOOSER(Visitor_t)::type&gt; IntermedVis; 
<a name="l00863"></a>00863     IntermedVis
<a name="l00864"></a>00864         visitor(online_visitor_, RF_CHOOSER(Visitor_t)::choose(visitor_, stopvisiting));
<a name="l00865"></a>00865 <span class="preprocessor">    #undef RF_CHOOSER</span>
<a name="l00866"></a>00866 <span class="preprocessor"></span>    vigra_precondition(options_.prepare_online_learning_,<span class="stringliteral">&quot;reLearnTree: Re learning trees only makes sense, if online learning is enabled&quot;</span>);
<a name="l00867"></a>00867     online_visitor_.activate();
<a name="l00868"></a>00868 
<a name="l00869"></a>00869     <span class="comment">// Make stl compatible random functor.</span>
<a name="l00870"></a>00870     RandFunctor_t           randint     ( random);
<a name="l00871"></a>00871 
<a name="l00872"></a>00872     <span class="comment">// Preprocess the data to get something the split functor can work</span>
<a name="l00873"></a>00873     <span class="comment">// with. Also fill the ext_param structure by preprocessing</span>
<a name="l00874"></a>00874     <span class="comment">// option parameters that could only be completely evaluated</span>
<a name="l00875"></a>00875     <span class="comment">// when the training data is known.</span>
<a name="l00876"></a>00876     Preprocessor_t preprocessor(    features, response,
<a name="l00877"></a>00877                                     options_, ext_param_);
<a name="l00878"></a>00878 
<a name="l00879"></a>00879     <span class="comment">// Give the Split functor information about the data.</span>
<a name="l00880"></a>00880     split.set_external_parameters(ext_param_);
<a name="l00881"></a>00881     stop.set_external_parameters(ext_param_);
<a name="l00882"></a>00882 <span class="comment"></span>
<a name="l00883"></a>00883 <span class="comment">    /**\todo    replace this crappy class out. It uses function pointers.</span>
<a name="l00884"></a>00884 <span class="comment">     *          and is making code slower according to me.</span>
<a name="l00885"></a>00885 <span class="comment">     *          Comment from Nathan: This is copied from Rahul, so me=Rahul</span>
<a name="l00886"></a>00886 <span class="comment">     */</span>
<a name="l00887"></a>00887     <a class="code" href="classvigra_1_1Sampler.html" title="Create random samples from a sequence of indices.">Sampler&lt;Random_t &gt;</a> sampler(preprocessor.strata().begin(),
<a name="l00888"></a>00888                                preprocessor.strata().end(),
<a name="l00889"></a>00889                                detail::make_sampler_opt(options_)
<a name="l00890"></a>00890                                         .sampleSize(ext_param().actual_msample_),
<a name="l00891"></a>00891                                &amp;random);
<a name="l00892"></a>00892     <span class="comment">//initialize First region/node/stack entry</span>
<a name="l00893"></a>00893     sampler
<a name="l00894"></a>00894         .<a class="code" href="group__MachineLearning.html#ga50a2ce599e896bfb535e70a42003ed23">sample</a>();
<a name="l00895"></a>00895 
<a name="l00896"></a>00896     <a class="code" href="classvigra_1_1DT__StackEntry.html">StackEntry_t</a>
<a name="l00897"></a>00897         first_stack_entry(  sampler.sampledIndices().begin(),
<a name="l00898"></a>00898                             sampler.sampledIndices().end(),
<a name="l00899"></a>00899                             ext_param_.class_count_);
<a name="l00900"></a>00900     first_stack_entry
<a name="l00901"></a>00901         .set_oob_range(     sampler.oobIndices().begin(),
<a name="l00902"></a>00902                             sampler.oobIndices().end());
<a name="l00903"></a>00903     online_visitor_.reset_tree(treeId);
<a name="l00904"></a>00904     online_visitor_.tree_id=treeId;
<a name="l00905"></a>00905     trees_[treeId].reset();
<a name="l00906"></a>00906     trees_[treeId]
<a name="l00907"></a>00907         .learn( preprocessor.features(),
<a name="l00908"></a>00908                 preprocessor.response(),
<a name="l00909"></a>00909                 first_stack_entry,
<a name="l00910"></a>00910                 split,
<a name="l00911"></a>00911                 stop,
<a name="l00912"></a>00912                 visitor,
<a name="l00913"></a>00913                 randint);
<a name="l00914"></a>00914     visitor
<a name="l00915"></a>00915         .visit_after_tree(  *<span class="keyword">this</span>,
<a name="l00916"></a>00916                             preprocessor,
<a name="l00917"></a>00917                             sampler,
<a name="l00918"></a>00918                             first_stack_entry,
<a name="l00919"></a>00919                             treeId);
<a name="l00920"></a>00920 
<a name="l00921"></a>00921     online_visitor_.deactivate();
<a name="l00922"></a>00922 }
<a name="l00923"></a>00923 
<a name="l00924"></a>00924 <span class="keyword">template</span> &lt;<span class="keyword">class</span> LabelType, <span class="keyword">class</span> PreprocessorTag&gt;
<a name="l00925"></a>00925 <span class="keyword">template</span> &lt;<span class="keyword">class </span>U, <span class="keyword">class </span>C1,
<a name="l00926"></a>00926          <span class="keyword">class </span>U2,<span class="keyword">class </span>C2,
<a name="l00927"></a>00927          <span class="keyword">class </span>Split_t,
<a name="l00928"></a>00928          <span class="keyword">class </span>Stop_t,
<a name="l00929"></a>00929          <span class="keyword">class </span>Visitor_t,
<a name="l00930"></a>00930          <span class="keyword">class </span>Random_t&gt;
<a name="l00931"></a>00931 <span class="keywordtype">void</span> <a class="code" href="group__MachineLearning.html#ga11157c680b4f47c5592d6695b5fbac05" title="learn on data with custom config and random number generator">RandomForest&lt;LabelType, PreprocessorTag&gt;::</a>
<a name="l00932"></a><a class="code" href="group__MachineLearning.html#ga11157c680b4f47c5592d6695b5fbac05">00932</a> <a class="code" href="group__MachineLearning.html#ga11157c680b4f47c5592d6695b5fbac05" title="learn on data with custom config and random number generator">                     learn</a>( <a class="code" href="classvigra_1_1MultiArrayView.html" title="Base class for, and view to, vigra::MultiArray.">MultiArrayView&lt;2, U, C1&gt;</a> <span class="keyword">const</span>  &amp;   features,
<a name="l00933"></a>00933                             <a class="code" href="classvigra_1_1MultiArrayView.html" title="Base class for, and view to, vigra::MultiArray.">MultiArrayView&lt;2, U2,C2&gt;</a> <span class="keyword">const</span>  &amp;   response,
<a name="l00934"></a>00934                             Visitor_t                           visitor_,
<a name="l00935"></a>00935                             Split_t                             split_,
<a name="l00936"></a>00936                             Stop_t                              stop_,
<a name="l00937"></a>00937                             Random_t                 <span class="keyword">const</span>  &amp;   random)
<a name="l00938"></a>00938 {
<a name="l00939"></a>00939     <span class="keyword">using namespace </span>rf;
<a name="l00940"></a>00940     <span class="comment">//this-&gt;reset();</span>
<a name="l00941"></a>00941     <span class="comment">//typedefs</span>
<a name="l00942"></a>00942     <span class="keyword">typedef</span>          <a class="code" href="classvigra_1_1UniformIntRandomFunctor.html">UniformIntRandomFunctor&lt;Random_t&gt;</a>
<a name="l00943"></a>00943                                                     RandFunctor_t;
<a name="l00944"></a>00944 
<a name="l00945"></a>00945     <span class="comment">// See rf_preprocessing.hxx for more info on this</span>
<a name="l00946"></a>00946     <span class="keyword">typedef</span> Processor&lt;PreprocessorTag,LabelType, U, C1, U2, C2&gt; Preprocessor_t;
<a name="l00947"></a>00947 
<a name="l00948"></a>00948     vigra_precondition(features.<a class="code" href="classvigra_1_1MultiArrayView.html#a53c8f0d5c70f10f31fbc246cbe524e32">shape</a>(0) == response.<a class="code" href="classvigra_1_1MultiArrayView.html#a53c8f0d5c70f10f31fbc246cbe524e32">shape</a>(0),
<a name="l00949"></a>00949         <span class="stringliteral">&quot;RandomForest::learn(): shape mismatch between features and response.&quot;</span>);
<a name="l00950"></a>00950     
<a name="l00951"></a>00951     <span class="comment">// default values and initialization</span>
<a name="l00952"></a>00952     <span class="comment">// Value Chooser chooses second argument as value if first argument</span>
<a name="l00953"></a>00953     <span class="comment">// is of type RF_DEFAULT. (thanks to template magic - don&#39;t care about</span>
<a name="l00954"></a>00954     <span class="comment">// it - just smile and wave).</span>
<a name="l00955"></a>00955     
<a name="l00956"></a>00956 <span class="preprocessor">    #define RF_CHOOSER(type_) detail::Value_Chooser&lt;type_, Default_##type_&gt; </span>
<a name="l00957"></a>00957 <span class="preprocessor"></span>    <a class="code" href="classvigra_1_1EarlyStoppStd.html" title="Standard early stopping criterion.">Default_Stop_t</a> default_stop(options_);
<a name="l00958"></a>00958     <span class="keyword">typename</span> RF_CHOOSER(Stop_t)::type stop
<a name="l00959"></a>00959             = RF_CHOOSER(Stop_t)::choose(stop_, default_stop); 
<a name="l00960"></a>00960     <a class="code" href="classvigra_1_1ThresholdSplit.html">Default_Split_t</a> default_split;
<a name="l00961"></a>00961     <span class="keyword">typename</span> RF_CHOOSER(Split_t)::type split 
<a name="l00962"></a>00962             = RF_CHOOSER(Split_t)::choose(split_, default_split); 
<a name="l00963"></a>00963     <a class="code" href="classvigra_1_1rf_1_1visitors_1_1StopVisiting.html">rf::visitors::StopVisiting</a> stopvisiting;
<a name="l00964"></a>00964     <span class="keyword">typedef</span>  <a class="code" href="classvigra_1_1rf_1_1visitors_1_1detail_1_1VisitorNode.html">rf::visitors::detail::VisitorNode</a>&lt;
<a name="l00965"></a>00965                 <a class="code" href="classvigra_1_1rf_1_1visitors_1_1OnlineLearnVisitor.html">rf::visitors::OnlineLearnVisitor</a>, 
<a name="l00966"></a>00966                 <span class="keyword">typename</span> RF_CHOOSER(Visitor_t)::type&gt; IntermedVis; 
<a name="l00967"></a>00967     IntermedVis
<a name="l00968"></a>00968         visitor(online_visitor_, RF_CHOOSER(Visitor_t)::choose(visitor_, stopvisiting));
<a name="l00969"></a>00969 <span class="preprocessor">    #undef RF_CHOOSER</span>
<a name="l00970"></a>00970 <span class="preprocessor"></span>    <span class="keywordflow">if</span>(options_.prepare_online_learning_)
<a name="l00971"></a>00971         online_visitor_.activate();
<a name="l00972"></a>00972     <span class="keywordflow">else</span>
<a name="l00973"></a>00973         online_visitor_.deactivate();
<a name="l00974"></a>00974 
<a name="l00975"></a>00975 
<a name="l00976"></a>00976     <span class="comment">// Make stl compatible random functor.</span>
<a name="l00977"></a>00977     RandFunctor_t           randint     ( random);
<a name="l00978"></a>00978 
<a name="l00979"></a>00979 
<a name="l00980"></a>00980     <span class="comment">// Preprocess the data to get something the split functor can work</span>
<a name="l00981"></a>00981     <span class="comment">// with. Also fill the ext_param structure by preprocessing</span>
<a name="l00982"></a>00982     <span class="comment">// option parameters that could only be completely evaluated</span>
<a name="l00983"></a>00983     <span class="comment">// when the training data is known.</span>
<a name="l00984"></a>00984     Preprocessor_t preprocessor(    features, response,
<a name="l00985"></a>00985                                     options_, ext_param_);
<a name="l00986"></a>00986 
<a name="l00987"></a>00987     <span class="comment">// Give the Split functor information about the data.</span>
<a name="l00988"></a>00988     split.set_external_parameters(ext_param_);
<a name="l00989"></a>00989     stop.set_external_parameters(ext_param_);
<a name="l00990"></a>00990 
<a name="l00991"></a>00991 
<a name="l00992"></a>00992     <span class="comment">//initialize trees.</span>
<a name="l00993"></a>00993     trees_.resize(options_.tree_count_  , DecisionTree_t(ext_param_));
<a name="l00994"></a>00994 
<a name="l00995"></a>00995     <a class="code" href="classvigra_1_1Sampler.html" title="Create random samples from a sequence of indices.">Sampler&lt;Random_t &gt;</a> sampler(preprocessor.strata().begin(),
<a name="l00996"></a>00996                                preprocessor.strata().end(),
<a name="l00997"></a>00997                                detail::make_sampler_opt(options_)
<a name="l00998"></a>00998                                         .sampleSize(ext_param().actual_msample_),
<a name="l00999"></a>00999                                &amp;random);
<a name="l01000"></a>01000 
<a name="l01001"></a>01001     visitor.visit_at_beginning(*<span class="keyword">this</span>, preprocessor);
<a name="l01002"></a>01002     <span class="comment">// THE MAIN EFFING RF LOOP - YEAY DUDE!</span>
<a name="l01003"></a>01003     
<a name="l01004"></a>01004     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ii = 0; ii &lt; (int)trees_.size(); ++ii)
<a name="l01005"></a>01005     {
<a name="l01006"></a>01006         <span class="comment">//initialize First region/node/stack entry</span>
<a name="l01007"></a>01007         sampler
<a name="l01008"></a>01008             .<a class="code" href="group__MachineLearning.html#ga50a2ce599e896bfb535e70a42003ed23">sample</a>();  
<a name="l01009"></a>01009         <a class="code" href="classvigra_1_1DT__StackEntry.html">StackEntry_t</a>
<a name="l01010"></a>01010             first_stack_entry(  sampler.sampledIndices().begin(),
<a name="l01011"></a>01011                                 sampler.sampledIndices().end(),
<a name="l01012"></a>01012                                 ext_param_.class_count_);
<a name="l01013"></a>01013         first_stack_entry
<a name="l01014"></a>01014             .set_oob_range(     sampler.oobIndices().begin(),
<a name="l01015"></a>01015                                 sampler.oobIndices().end());
<a name="l01016"></a>01016         trees_[ii]
<a name="l01017"></a>01017             .learn(             preprocessor.features(),
<a name="l01018"></a>01018                                 preprocessor.response(),
<a name="l01019"></a>01019                                 first_stack_entry,
<a name="l01020"></a>01020                                 split,
<a name="l01021"></a>01021                                 stop,
<a name="l01022"></a>01022                                 visitor,
<a name="l01023"></a>01023                                 randint);
<a name="l01024"></a>01024         visitor
<a name="l01025"></a>01025             .visit_after_tree(  *<span class="keyword">this</span>,
<a name="l01026"></a>01026                                 preprocessor,
<a name="l01027"></a>01027                                 sampler,
<a name="l01028"></a>01028                                 first_stack_entry,
<a name="l01029"></a>01029                                 ii);
<a name="l01030"></a>01030     }
<a name="l01031"></a>01031 
<a name="l01032"></a>01032     visitor.visit_at_end(*<span class="keyword">this</span>, preprocessor);
<a name="l01033"></a>01033     <span class="comment">// Only for online learning?</span>
<a name="l01034"></a>01034     online_visitor_.deactivate();
<a name="l01035"></a>01035 }
<a name="l01036"></a>01036 
<a name="l01037"></a>01037 
<a name="l01038"></a>01038 
<a name="l01039"></a>01039 
<a name="l01040"></a>01040 <span class="keyword">template</span> &lt;<span class="keyword">class</span> LabelType, <span class="keyword">class</span> Tag&gt;
<a name="l01041"></a>01041 <span class="keyword">template</span> &lt;<span class="keyword">class</span> U, <span class="keyword">class</span> C, <span class="keyword">class</span> Stop&gt;
<a name="l01042"></a>01042 LabelType <a class="code" href="group__MachineLearning.html#gaf79cd1eb1287d9d26dd90be5cb971645" title="predict a label given a feature.">RandomForest&lt;LabelType, Tag&gt;</a>
<a name="l01043"></a><a class="code" href="group__MachineLearning.html#gaf79cd1eb1287d9d26dd90be5cb971645">01043</a> <a class="code" href="group__MachineLearning.html#gaf79cd1eb1287d9d26dd90be5cb971645" title="predict a label given a feature.">    ::predictLabel</a>(<a class="code" href="classvigra_1_1MultiArrayView.html" title="Base class for, and view to, vigra::MultiArray.">MultiArrayView&lt;2, U, C&gt;</a> <span class="keyword">const</span> &amp; features, Stop &amp; stop)<span class="keyword"> const</span>
<a name="l01044"></a>01044 <span class="keyword"></span>{
<a name="l01045"></a>01045     vigra_precondition(<a class="code" href="group__LinearAlgebraFunctions.html#ga40eab6d0fc1e179c173a3b90c9d991be">columnCount</a>(features) &gt;= ext_param_.column_count_,
<a name="l01046"></a>01046         <span class="stringliteral">&quot;RandomForestn::predictLabel():&quot;</span>
<a name="l01047"></a>01047             <span class="stringliteral">&quot; Too few columns in feature matrix.&quot;</span>);
<a name="l01048"></a>01048     vigra_precondition(<a class="code" href="group__LinearAlgebraFunctions.html#gaa88b5c1277c72b4d4e2b70c278efbffe">rowCount</a>(features) == 1,
<a name="l01049"></a>01049         <span class="stringliteral">&quot;RandomForestn::predictLabel():&quot;</span>
<a name="l01050"></a>01050             <span class="stringliteral">&quot; Feature matrix must have a singlerow.&quot;</span>);
<a name="l01051"></a>01051     <a class="code" href="classvigra_1_1MultiArray.html">MultiArray&lt;2, double&gt;</a> probabilities(<a class="code" href="group__MultiIteratorGroup.html#ga2e2ffc107bb0e38f9b1288b647c8ec5b" title="shape type for MultiArray&lt;2, T&gt;">Shape2</a>(1, ext_param_.class_count_), 0.0);
<a name="l01052"></a>01052     LabelType          d;
<a name="l01053"></a>01053     predictProbabilities(features, probabilities, stop);
<a name="l01054"></a>01054     ext_param_.to_classlabel(<a class="code" href="group__MathFunctions.html#gaf658d43400902a049a289c4e5ded84d9" title="Find the maximum element in a sequence.">argMax</a>(probabilities), d);
<a name="l01055"></a>01055     <span class="keywordflow">return</span> d;
<a name="l01056"></a>01056 }
<a name="l01057"></a>01057 
<a name="l01058"></a>01058 
<a name="l01059"></a>01059 <span class="comment">//Same thing as above with priors for each label !!!</span>
<a name="l01060"></a>01060 <span class="keyword">template</span> &lt;<span class="keyword">class</span> LabelType, <span class="keyword">class</span> PreprocessorTag&gt;
<a name="l01061"></a>01061 <span class="keyword">template</span> &lt;<span class="keyword">class</span> U, <span class="keyword">class</span> C&gt;
<a name="l01062"></a>01062 LabelType <a class="code" href="group__MachineLearning.html#gaf79cd1eb1287d9d26dd90be5cb971645" title="predict a label given a feature.">RandomForest&lt;LabelType, PreprocessorTag&gt;</a>
<a name="l01063"></a><a class="code" href="group__MachineLearning.html#ga75ac70b9d658f75208f5ffb5a15adbe2">01063</a> <a class="code" href="group__MachineLearning.html#gaf79cd1eb1287d9d26dd90be5cb971645" title="predict a label given a feature.">    ::predictLabel</a>( <a class="code" href="classvigra_1_1MultiArrayView.html" title="Base class for, and view to, vigra::MultiArray.">MultiArrayView&lt;2, U, C&gt;</a> <span class="keyword">const</span> &amp; features,
<a name="l01064"></a>01064                     <a class="code" href="classvigra_1_1ArrayVectorView.html">ArrayVectorView&lt;double&gt;</a> priors)<span class="keyword"> const</span>
<a name="l01065"></a>01065 <span class="keyword"></span>{
<a name="l01066"></a>01066     <span class="keyword">using namespace </span>functor;
<a name="l01067"></a>01067     vigra_precondition(<a class="code" href="group__LinearAlgebraFunctions.html#ga40eab6d0fc1e179c173a3b90c9d991be">columnCount</a>(features) &gt;= ext_param_.column_count_,
<a name="l01068"></a>01068         <span class="stringliteral">&quot;RandomForestn::predictLabel(): Too few columns in feature matrix.&quot;</span>);
<a name="l01069"></a>01069     vigra_precondition(<a class="code" href="group__LinearAlgebraFunctions.html#gaa88b5c1277c72b4d4e2b70c278efbffe">rowCount</a>(features) == 1,
<a name="l01070"></a>01070         <span class="stringliteral">&quot;RandomForestn::predictLabel():&quot;</span>
<a name="l01071"></a>01071         <span class="stringliteral">&quot; Feature matrix must have a single row.&quot;</span>);
<a name="l01072"></a>01072     Matrix&lt;double&gt;  prob(1,ext_param_.class_count_);
<a name="l01073"></a>01073     predictProbabilities(features, prob);
<a name="l01074"></a>01074     std::transform( prob.begin(), prob.end(),
<a name="l01075"></a>01075                     priors.<a class="code" href="classvigra_1_1ArrayVectorView.html#aa4b02d4f1a8500fb07a551069060709f">begin</a>(), prob.begin(),
<a name="l01076"></a>01076                     Arg1()*Arg2());
<a name="l01077"></a>01077     LabelType          d;
<a name="l01078"></a>01078     ext_param_.to_classlabel(<a class="code" href="group__MathFunctions.html#gaf658d43400902a049a289c4e5ded84d9" title="Find the maximum element in a sequence.">argMax</a>(prob), d);
<a name="l01079"></a>01079     <span class="keywordflow">return</span> d;
<a name="l01080"></a>01080 }
<a name="l01081"></a>01081 
<a name="l01082"></a>01082 <span class="keyword">template</span>&lt;<span class="keyword">class</span> LabelType,<span class="keyword">class</span> PreprocessorTag&gt;
<a name="l01083"></a>01083 <span class="keyword">template</span> &lt;<span class="keyword">class</span> T1,<span class="keyword">class</span> T2, <span class="keyword">class</span> C&gt;
<a name="l01084"></a>01084 <span class="keywordtype">void</span> <a class="code" href="group__MachineLearning.html#ga30e310de1642021af2e24d56be57a37d" title="predict the class probabilities for multiple labels">RandomForest&lt;LabelType,PreprocessorTag&gt;</a>
<a name="l01085"></a>01085 <a class="code" href="group__MachineLearning.html#ga30e310de1642021af2e24d56be57a37d" title="predict the class probabilities for multiple labels">    ::predictProbabilities</a>(OnlinePredictionSet&lt;T1&gt; &amp;  predictionSet,
<a name="l01086"></a>01086                           <a class="code" href="classvigra_1_1MultiArrayView.html" title="Base class for, and view to, vigra::MultiArray.">MultiArrayView&lt;2, T2, C&gt;</a> &amp;       prob)
<a name="l01087"></a>01087 {
<a name="l01088"></a>01088     <span class="comment">//Features are n xp</span>
<a name="l01089"></a>01089     <span class="comment">//prob is n x NumOfLabel probability for each feature in each class</span>
<a name="l01090"></a>01090     
<a name="l01091"></a>01091     vigra_precondition(<a class="code" href="group__LinearAlgebraFunctions.html#gaa88b5c1277c72b4d4e2b70c278efbffe">rowCount</a>(predictionSet.features) == <a class="code" href="group__LinearAlgebraFunctions.html#gaa88b5c1277c72b4d4e2b70c278efbffe">rowCount</a>(prob),
<a name="l01092"></a>01092                        <span class="stringliteral">&quot;RandomFroest::predictProbabilities():&quot;</span>
<a name="l01093"></a>01093                        <span class="stringliteral">&quot; Feature matrix and probability matrix size mismatch.&quot;</span>);
<a name="l01094"></a>01094     <span class="comment">// num of features must be bigger than num of features in Random forest training</span>
<a name="l01095"></a>01095     <span class="comment">// but why bigger?</span>
<a name="l01096"></a>01096     vigra_precondition( <a class="code" href="group__LinearAlgebraFunctions.html#ga40eab6d0fc1e179c173a3b90c9d991be">columnCount</a>(predictionSet.features) &gt;= ext_param_.column_count_,
<a name="l01097"></a>01097       <span class="stringliteral">&quot;RandomForestn::predictProbabilities():&quot;</span>
<a name="l01098"></a>01098         <span class="stringliteral">&quot; Too few columns in feature matrix.&quot;</span>);
<a name="l01099"></a>01099     vigra_precondition( <a class="code" href="group__LinearAlgebraFunctions.html#ga40eab6d0fc1e179c173a3b90c9d991be">columnCount</a>(prob)
<a name="l01100"></a>01100                         == (<a class="code" href="group__MultiIteratorGroup.html#gac436173a0374e960a463a9186496ab70">MultiArrayIndex</a>)ext_param_.class_count_,
<a name="l01101"></a>01101       <span class="stringliteral">&quot;RandomForestn::predictProbabilities():&quot;</span>
<a name="l01102"></a>01102       <span class="stringliteral">&quot; Probability matrix must have as many columns as there are classes.&quot;</span>);
<a name="l01103"></a>01103     prob.<a class="code" href="classvigra_1_1MultiArrayView.html#ae8d75c08347781b9854c8aea98c34610">init</a>(0.0);
<a name="l01104"></a>01104     <span class="comment">//store total weights</span>
<a name="l01105"></a>01105     std::vector&lt;T1&gt; totalWeights(predictionSet.indices[0].size(),0.0);
<a name="l01106"></a>01106     <span class="comment">//Go through all trees</span>
<a name="l01107"></a>01107     <span class="keywordtype">int</span> set_id=-1;
<a name="l01108"></a>01108     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> k=0; k&lt;options_.tree_count_; ++k)
<a name="l01109"></a>01109     {
<a name="l01110"></a>01110         set_id=(set_id+1) % predictionSet.indices[0].size();
<a name="l01111"></a>01111         <span class="keyword">typedef</span> std::set&lt;SampleRange&lt;T1&gt; &gt; my_set;
<a name="l01112"></a>01112         <span class="keyword">typedef</span> <span class="keyword">typename</span> my_set::iterator set_it;
<a name="l01113"></a>01113         <span class="comment">//typedef std::set&lt;std::pair&lt;int,SampleRange&lt;T1&gt; &gt; &gt;::iterator set_it;</span>
<a name="l01114"></a>01114         <span class="comment">//Build a stack with all the ranges we have</span>
<a name="l01115"></a>01115         std::vector&lt;std::pair&lt;int,set_it&gt; &gt; stack;
<a name="l01116"></a>01116         stack.clear();
<a name="l01117"></a>01117         <span class="keywordflow">for</span>(set_it i=predictionSet.ranges[set_id].begin();
<a name="l01118"></a>01118              i!=predictionSet.ranges[set_id].end();++i)
<a name="l01119"></a>01119             stack.push_back(std::pair&lt;int,set_it&gt;(2,i));
<a name="l01120"></a>01120         <span class="comment">//get weights predicted by single tree</span>
<a name="l01121"></a>01121         <span class="keywordtype">int</span> num_decisions=0;
<a name="l01122"></a>01122         <span class="keywordflow">while</span>(!stack.empty())
<a name="l01123"></a>01123         {
<a name="l01124"></a>01124             set_it range=stack.back().second;
<a name="l01125"></a>01125             <span class="keywordtype">int</span> index=stack.back().first;
<a name="l01126"></a>01126             stack.pop_back();
<a name="l01127"></a>01127             ++num_decisions;
<a name="l01128"></a>01128 
<a name="l01129"></a>01129             <span class="keywordflow">if</span>(trees_[k].isLeafNode(trees_[k].topology_[index]))
<a name="l01130"></a>01130             {
<a name="l01131"></a>01131                 <a class="code" href="classvigra_1_1ArrayVector.html">ArrayVector&lt;double&gt;::iterator</a> weights=<a class="code" href="classvigra_1_1Node_3_01e__ConstProbNode_01_4.html">Node&lt;e_ConstProbNode&gt;</a>(trees_[k].topology_,
<a name="l01132"></a>01132                                                                             trees_[k].parameters_,
<a name="l01133"></a>01133                                                                             index).prob_begin();
<a name="l01134"></a>01134                 <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=range-&gt;start;i!=range-&gt;end;++i)
<a name="l01135"></a>01135                 {
<a name="l01136"></a>01136                     <span class="comment">//update votecount.</span>
<a name="l01137"></a>01137                     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> l=0; l&lt;ext_param_.class_count_; ++l)
<a name="l01138"></a>01138                     {
<a name="l01139"></a>01139                         prob(predictionSet.indices[set_id][i], l) += (T2)weights[l];
<a name="l01140"></a>01140                         <span class="comment">//every weight in totalWeight.</span>
<a name="l01141"></a>01141                         totalWeights[predictionSet.indices[set_id][i]] += (T1)weights[l];
<a name="l01142"></a>01142                     }
<a name="l01143"></a>01143                 }
<a name="l01144"></a>01144             }
<a name="l01145"></a>01145 
<a name="l01146"></a>01146             <span class="keywordflow">else</span>
<a name="l01147"></a>01147             {
<a name="l01148"></a>01148                 <span class="keywordflow">if</span>(trees_[k].topology_[index]!=i_ThresholdNode)
<a name="l01149"></a>01149                 {
<a name="l01150"></a>01150                     <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">&quot;predicting with online prediction sets is only supported for RFs with threshold nodes&quot;</span>);
<a name="l01151"></a>01151                 }
<a name="l01152"></a>01152                 Node&lt;i_ThresholdNode&gt; node(trees_[k].topology_,trees_[k].parameters_,index);
<a name="l01153"></a>01153                 <span class="keywordflow">if</span>(range-&gt;min_boundaries[node.column()]&gt;=node.threshold())
<a name="l01154"></a>01154                 {
<a name="l01155"></a>01155                     <span class="comment">//Everything goes to right child</span>
<a name="l01156"></a>01156                     stack.push_back(std::pair&lt;int,set_it&gt;(node.child(1),range));
<a name="l01157"></a>01157                     <span class="keywordflow">continue</span>;
<a name="l01158"></a>01158                 }
<a name="l01159"></a>01159                 <span class="keywordflow">if</span>(range-&gt;max_boundaries[node.column()]&lt;node.threshold())
<a name="l01160"></a>01160                 {
<a name="l01161"></a>01161                     <span class="comment">//Everything goes to the left child</span>
<a name="l01162"></a>01162                     stack.push_back(std::pair&lt;int,set_it&gt;(node.child(0),range));
<a name="l01163"></a>01163                     <span class="keywordflow">continue</span>;
<a name="l01164"></a>01164                 }
<a name="l01165"></a>01165                 <span class="comment">//We have to split at this node</span>
<a name="l01166"></a>01166                 SampleRange&lt;T1&gt; new_range=*range;
<a name="l01167"></a>01167                 new_range.min_boundaries[node.column()]=FLT_MAX;
<a name="l01168"></a>01168                 range-&gt;max_boundaries[node.column()]=-FLT_MAX;
<a name="l01169"></a>01169                 new_range.start=new_range.end=range-&gt;end;
<a name="l01170"></a>01170                 <span class="keywordtype">int</span> i=range-&gt;start;
<a name="l01171"></a>01171                 <span class="keywordflow">while</span>(i!=range-&gt;end)
<a name="l01172"></a>01172                 {
<a name="l01173"></a>01173                     <span class="comment">//Decide for range-&gt;indices[i]</span>
<a name="l01174"></a>01174                     <span class="keywordflow">if</span>(predictionSet.features(predictionSet.indices[set_id][i],node.column())&gt;=node.threshold())
<a name="l01175"></a>01175                     {
<a name="l01176"></a>01176                         new_range.min_boundaries[node.column()]=std::min(new_range.min_boundaries[node.column()],
<a name="l01177"></a>01177                                                                     predictionSet.features(predictionSet.indices[set_id][i],node.column()));
<a name="l01178"></a>01178                         --range-&gt;end;
<a name="l01179"></a>01179                         --new_range.start;
<a name="l01180"></a>01180                         std::swap(predictionSet.indices[set_id][i],predictionSet.indices[set_id][range-&gt;end]);
<a name="l01181"></a>01181 
<a name="l01182"></a>01182                     }
<a name="l01183"></a>01183                     <span class="keywordflow">else</span>
<a name="l01184"></a>01184                     {
<a name="l01185"></a>01185                         range-&gt;max_boundaries[node.column()]=std::max(range-&gt;max_boundaries[node.column()],
<a name="l01186"></a>01186                                                                  predictionSet.features(predictionSet.indices[set_id][i],node.column()));
<a name="l01187"></a>01187                         ++i;
<a name="l01188"></a>01188                     }
<a name="l01189"></a>01189                 }
<a name="l01190"></a>01190                 <span class="comment">//The old one ...</span>
<a name="l01191"></a>01191                 <span class="keywordflow">if</span>(range-&gt;start==range-&gt;end)
<a name="l01192"></a>01192                 {
<a name="l01193"></a>01193                     predictionSet.ranges[set_id].erase(range);
<a name="l01194"></a>01194                 }
<a name="l01195"></a>01195                 <span class="keywordflow">else</span>
<a name="l01196"></a>01196                 {
<a name="l01197"></a>01197                     stack.push_back(std::pair&lt;int,set_it&gt;(node.child(0),range));
<a name="l01198"></a>01198                 }
<a name="l01199"></a>01199                 <span class="comment">//And the new one ...</span>
<a name="l01200"></a>01200                 <span class="keywordflow">if</span>(new_range.start!=new_range.end)
<a name="l01201"></a>01201                 {
<a name="l01202"></a>01202                     std::pair&lt;set_it,bool&gt; new_it=predictionSet.ranges[set_id].insert(new_range);
<a name="l01203"></a>01203                     stack.push_back(std::pair&lt;int,set_it&gt;(node.child(1),new_it.first));
<a name="l01204"></a>01204                 }
<a name="l01205"></a>01205             }
<a name="l01206"></a>01206         }
<a name="l01207"></a>01207         predictionSet.cumulativePredTime[k]=num_decisions;
<a name="l01208"></a>01208     }
<a name="l01209"></a>01209     <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0;i&lt;totalWeights.size();++i)
<a name="l01210"></a>01210     {
<a name="l01211"></a>01211         <span class="keywordtype">double</span> test=0.0;
<a name="l01212"></a>01212         <span class="comment">//Normalise votes in each row by total VoteCount (totalWeight</span>
<a name="l01213"></a>01213         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> l=0; l&lt;ext_param_.class_count_; ++l)
<a name="l01214"></a>01214         {
<a name="l01215"></a>01215             test+=prob(i,l);
<a name="l01216"></a>01216             prob(i, l) /= totalWeights[i];
<a name="l01217"></a>01217         }
<a name="l01218"></a>01218         assert(test==totalWeights[i]);
<a name="l01219"></a>01219         assert(totalWeights[i]&gt;0.0);
<a name="l01220"></a>01220     }
<a name="l01221"></a>01221 }
<a name="l01222"></a>01222 
<a name="l01223"></a>01223 <span class="keyword">template</span> &lt;<span class="keyword">class</span> LabelType, <span class="keyword">class</span> PreprocessorTag&gt;
<a name="l01224"></a>01224 <span class="keyword">template</span> &lt;<span class="keyword">class</span> U, <span class="keyword">class</span> C1, <span class="keyword">class</span> T, <span class="keyword">class</span> C2, <span class="keyword">class</span> Stop_t&gt;
<a name="l01225"></a>01225 <span class="keywordtype">void</span> <a class="code" href="group__MachineLearning.html#ga30e310de1642021af2e24d56be57a37d" title="predict the class probabilities for multiple labels">RandomForest&lt;LabelType, PreprocessorTag&gt;</a>
<a name="l01226"></a>01226 <a class="code" href="group__MachineLearning.html#ga30e310de1642021af2e24d56be57a37d" title="predict the class probabilities for multiple labels">    ::predictProbabilities</a>(MultiArrayView&lt;2, U, C1&gt;<span class="keyword">const</span> &amp;  features,
<a name="l01227"></a>01227                            MultiArrayView&lt;2, T, C2&gt; &amp;       prob,
<a name="l01228"></a>01228                            Stop_t                   &amp;       stop_)<span class="keyword"> const</span>
<a name="l01229"></a>01229 <span class="keyword"></span>{
<a name="l01230"></a>01230     <span class="comment">//Features are n xp</span>
<a name="l01231"></a>01231     <span class="comment">//prob is n x NumOfLabel probability for each feature in each class</span>
<a name="l01232"></a>01232 
<a name="l01233"></a>01233     vigra_precondition(<a class="code" href="group__LinearAlgebraFunctions.html#gaa88b5c1277c72b4d4e2b70c278efbffe">rowCount</a>(features) == <a class="code" href="group__LinearAlgebraFunctions.html#gaa88b5c1277c72b4d4e2b70c278efbffe">rowCount</a>(prob),
<a name="l01234"></a>01234       <span class="stringliteral">&quot;RandomForestn::predictProbabilities():&quot;</span>
<a name="l01235"></a>01235         <span class="stringliteral">&quot; Feature matrix and probability matrix size mismatch.&quot;</span>);
<a name="l01236"></a>01236 
<a name="l01237"></a>01237     <span class="comment">// num of features must be bigger than num of features in Random forest training</span>
<a name="l01238"></a>01238     <span class="comment">// but why bigger?</span>
<a name="l01239"></a>01239     vigra_precondition( <a class="code" href="group__LinearAlgebraFunctions.html#ga40eab6d0fc1e179c173a3b90c9d991be">columnCount</a>(features) &gt;= ext_param_.column_count_,
<a name="l01240"></a>01240       <span class="stringliteral">&quot;RandomForestn::predictProbabilities():&quot;</span>
<a name="l01241"></a>01241         <span class="stringliteral">&quot; Too few columns in feature matrix.&quot;</span>);
<a name="l01242"></a>01242     vigra_precondition( <a class="code" href="group__LinearAlgebraFunctions.html#ga40eab6d0fc1e179c173a3b90c9d991be">columnCount</a>(prob)
<a name="l01243"></a>01243                         == (<a class="code" href="group__MultiIteratorGroup.html#gac436173a0374e960a463a9186496ab70">MultiArrayIndex</a>)ext_param_.class_count_,
<a name="l01244"></a>01244       <span class="stringliteral">&quot;RandomForestn::predictProbabilities():&quot;</span>
<a name="l01245"></a>01245       <span class="stringliteral">&quot; Probability matrix must have as many columns as there are classes.&quot;</span>);
<a name="l01246"></a>01246 
<a name="l01247"></a>01247 <span class="preprocessor">    #define RF_CHOOSER(type_) detail::Value_Chooser&lt;type_, Default_##type_&gt; </span>
<a name="l01248"></a>01248 <span class="preprocessor"></span>    Default_Stop_t default_stop(options_);
<a name="l01249"></a>01249     <span class="keyword">typename</span> RF_CHOOSER(Stop_t)::type &amp; stop
<a name="l01250"></a>01250             = RF_CHOOSER(Stop_t)::choose(stop_, default_stop); 
<a name="l01251"></a>01251 <span class="preprocessor">    #undef RF_CHOOSER </span>
<a name="l01252"></a>01252 <span class="preprocessor"></span>    stop.set_external_parameters(ext_param_, tree_count());
<a name="l01253"></a>01253     prob.init(NumericTraits&lt;T&gt;::zero());
<a name="l01254"></a>01254     <span class="comment">/* This code was originally there for testing early stopping</span>
<a name="l01255"></a>01255 <span class="comment">     * - we wanted the order of the trees to be randomized</span>
<a name="l01256"></a>01256 <span class="comment">    if(tree_indices_.size() != 0)</span>
<a name="l01257"></a>01257 <span class="comment">    {</span>
<a name="l01258"></a>01258 <span class="comment">       std::random_shuffle(tree_indices_.begin(),</span>
<a name="l01259"></a>01259 <span class="comment">                           tree_indices_.end()); </span>
<a name="l01260"></a>01260 <span class="comment">    }</span>
<a name="l01261"></a>01261 <span class="comment">    */</span>
<a name="l01262"></a>01262     <span class="comment">//Classify for each row.</span>
<a name="l01263"></a>01263     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> row=0; row &lt; <a class="code" href="group__LinearAlgebraFunctions.html#gaa88b5c1277c72b4d4e2b70c278efbffe">rowCount</a>(features); ++row)
<a name="l01264"></a>01264     {
<a name="l01265"></a>01265         MultiArrayView&lt;2, U, StridedArrayTag&gt; currentRow(<a class="code" href="group__LinearAlgebraFunctions.html#ga8cc5e13ed0643c0d9b8c9021eaae625d">rowVector</a>(features, row));
<a name="l01266"></a>01266         
<a name="l01267"></a>01267         <span class="comment">// when the features contain an NaN, the instance doesn&#39;t belong to any class</span>
<a name="l01268"></a>01268         <span class="comment">// =&gt; indicate this by returning a zero probability array.</span>
<a name="l01269"></a>01269         <span class="keywordflow">if</span>(detail::contains_nan(currentRow))
<a name="l01270"></a>01270         {
<a name="l01271"></a>01271             <a class="code" href="group__LinearAlgebraFunctions.html#ga8cc5e13ed0643c0d9b8c9021eaae625d">rowVector</a>(prob, row).init(0.0);
<a name="l01272"></a>01272             <span class="keywordflow">continue</span>;
<a name="l01273"></a>01273         }
<a name="l01274"></a>01274     
<a name="l01275"></a>01275         ArrayVector&lt;double&gt;::const_iterator weights;
<a name="l01276"></a>01276 
<a name="l01277"></a>01277         <span class="comment">//totalWeight == totalVoteCount!</span>
<a name="l01278"></a>01278         <span class="keywordtype">double</span> totalWeight = 0.0;
<a name="l01279"></a>01279 
<a name="l01280"></a>01280         <span class="comment">//Let each tree classify...</span>
<a name="l01281"></a>01281         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> k=0; k&lt;options_.tree_count_; ++k)
<a name="l01282"></a>01282         {
<a name="l01283"></a>01283             <span class="comment">//get weights predicted by single tree</span>
<a name="l01284"></a>01284             weights = trees_[k <span class="comment">/*tree_indices_[k]*/</span>].predict(currentRow);
<a name="l01285"></a>01285 
<a name="l01286"></a>01286             <span class="comment">//update votecount.</span>
<a name="l01287"></a>01287             <span class="keywordtype">int</span> weighted = options_.predict_weighted_;
<a name="l01288"></a>01288             <span class="keywordflow">for</span>(<span class="keywordtype">int</span> l=0; l&lt;ext_param_.class_count_; ++l)
<a name="l01289"></a>01289             {
<a name="l01290"></a>01290                 <span class="keywordtype">double</span> cur_w = weights[l] * (weighted * (*(weights-1))
<a name="l01291"></a>01291                                            + (1-weighted));
<a name="l01292"></a>01292                 prob(row, l) += (T)cur_w;
<a name="l01293"></a>01293                 <span class="comment">//every weight in totalWeight.</span>
<a name="l01294"></a>01294                 totalWeight += cur_w;
<a name="l01295"></a>01295             }
<a name="l01296"></a>01296             <span class="keywordflow">if</span>(stop.after_prediction(weights, 
<a name="l01297"></a>01297                                      k,
<a name="l01298"></a>01298                                      <a class="code" href="group__LinearAlgebraFunctions.html#ga8cc5e13ed0643c0d9b8c9021eaae625d">rowVector</a>(prob, row),
<a name="l01299"></a>01299                                      totalWeight))
<a name="l01300"></a>01300             {
<a name="l01301"></a>01301                 <span class="keywordflow">break</span>;
<a name="l01302"></a>01302             }
<a name="l01303"></a>01303         }
<a name="l01304"></a>01304 
<a name="l01305"></a>01305         <span class="comment">//Normalise votes in each row by total VoteCount (totalWeight</span>
<a name="l01306"></a>01306         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> l=0; l&lt; ext_param_.class_count_; ++l)
<a name="l01307"></a>01307         {
<a name="l01308"></a>01308             prob(row, l) /= detail::RequiresExplicitCast&lt;T&gt;::cast(totalWeight);
<a name="l01309"></a>01309         }
<a name="l01310"></a>01310     }
<a name="l01311"></a>01311 
<a name="l01312"></a>01312 }
<a name="l01313"></a>01313 
<a name="l01314"></a>01314 <span class="keyword">template</span> &lt;<span class="keyword">class</span> LabelType, <span class="keyword">class</span> PreprocessorTag&gt;
<a name="l01315"></a>01315 <span class="keyword">template</span> &lt;<span class="keyword">class</span> U, <span class="keyword">class</span> C1, <span class="keyword">class</span> T, <span class="keyword">class</span> C2&gt;
<a name="l01316"></a>01316 <span class="keywordtype">void</span> RandomForest&lt;LabelType, PreprocessorTag&gt;
<a name="l01317"></a>01317     ::predictRaw(MultiArrayView&lt;2, U, C1&gt;<span class="keyword">const</span> &amp;  features,
<a name="l01318"></a>01318                            MultiArrayView&lt;2, T, C2&gt; &amp;       prob)<span class="keyword"> const</span>
<a name="l01319"></a>01319 <span class="keyword"></span>{
<a name="l01320"></a>01320     <span class="comment">//Features are n xp</span>
<a name="l01321"></a>01321     <span class="comment">//prob is n x NumOfLabel probability for each feature in each class</span>
<a name="l01322"></a>01322 
<a name="l01323"></a>01323     vigra_precondition(<a class="code" href="group__LinearAlgebraFunctions.html#gaa88b5c1277c72b4d4e2b70c278efbffe">rowCount</a>(features) == <a class="code" href="group__LinearAlgebraFunctions.html#gaa88b5c1277c72b4d4e2b70c278efbffe">rowCount</a>(prob),
<a name="l01324"></a>01324       <span class="stringliteral">&quot;RandomForestn::predictProbabilities():&quot;</span>
<a name="l01325"></a>01325         <span class="stringliteral">&quot; Feature matrix and probability matrix size mismatch.&quot;</span>);
<a name="l01326"></a>01326 
<a name="l01327"></a>01327     <span class="comment">// num of features must be bigger than num of features in Random forest training</span>
<a name="l01328"></a>01328     <span class="comment">// but why bigger?</span>
<a name="l01329"></a>01329     vigra_precondition( <a class="code" href="group__LinearAlgebraFunctions.html#ga40eab6d0fc1e179c173a3b90c9d991be">columnCount</a>(features) &gt;= ext_param_.column_count_,
<a name="l01330"></a>01330       <span class="stringliteral">&quot;RandomForestn::predictProbabilities():&quot;</span>
<a name="l01331"></a>01331         <span class="stringliteral">&quot; Too few columns in feature matrix.&quot;</span>);
<a name="l01332"></a>01332     vigra_precondition( <a class="code" href="group__LinearAlgebraFunctions.html#ga40eab6d0fc1e179c173a3b90c9d991be">columnCount</a>(prob)
<a name="l01333"></a>01333                         == (<a class="code" href="group__MultiIteratorGroup.html#gac436173a0374e960a463a9186496ab70">MultiArrayIndex</a>)ext_param_.class_count_,
<a name="l01334"></a>01334       <span class="stringliteral">&quot;RandomForestn::predictProbabilities():&quot;</span>
<a name="l01335"></a>01335       <span class="stringliteral">&quot; Probability matrix must have as many columns as there are classes.&quot;</span>);
<a name="l01336"></a>01336 
<a name="l01337"></a>01337 <span class="preprocessor">    #define RF_CHOOSER(type_) detail::Value_Chooser&lt;type_, Default_##type_&gt; </span>
<a name="l01338"></a>01338 <span class="preprocessor"></span>    prob.init(NumericTraits&lt;T&gt;::zero());
<a name="l01339"></a>01339     <span class="comment">/* This code was originally there for testing early stopping</span>
<a name="l01340"></a>01340 <span class="comment">     * - we wanted the order of the trees to be randomized</span>
<a name="l01341"></a>01341 <span class="comment">    if(tree_indices_.size() != 0)</span>
<a name="l01342"></a>01342 <span class="comment">    {</span>
<a name="l01343"></a>01343 <span class="comment">       std::random_shuffle(tree_indices_.begin(),</span>
<a name="l01344"></a>01344 <span class="comment">                           tree_indices_.end()); </span>
<a name="l01345"></a>01345 <span class="comment">    }</span>
<a name="l01346"></a>01346 <span class="comment">    */</span>
<a name="l01347"></a>01347     <span class="comment">//Classify for each row.</span>
<a name="l01348"></a>01348     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> row=0; row &lt; <a class="code" href="group__LinearAlgebraFunctions.html#gaa88b5c1277c72b4d4e2b70c278efbffe">rowCount</a>(features); ++row)
<a name="l01349"></a>01349     {
<a name="l01350"></a>01350         ArrayVector&lt;double&gt;::const_iterator weights;
<a name="l01351"></a>01351 
<a name="l01352"></a>01352         <span class="comment">//totalWeight == totalVoteCount!</span>
<a name="l01353"></a>01353         <span class="keywordtype">double</span> totalWeight = 0.0;
<a name="l01354"></a>01354 
<a name="l01355"></a>01355         <span class="comment">//Let each tree classify...</span>
<a name="l01356"></a>01356         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> k=0; k&lt;options_.tree_count_; ++k)
<a name="l01357"></a>01357         {
<a name="l01358"></a>01358             <span class="comment">//get weights predicted by single tree</span>
<a name="l01359"></a>01359             weights = trees_[k <span class="comment">/*tree_indices_[k]*/</span>].predict(<a class="code" href="group__LinearAlgebraFunctions.html#ga8cc5e13ed0643c0d9b8c9021eaae625d">rowVector</a>(features, row));
<a name="l01360"></a>01360 
<a name="l01361"></a>01361             <span class="comment">//update votecount.</span>
<a name="l01362"></a>01362             <span class="keywordtype">int</span> weighted = options_.predict_weighted_;
<a name="l01363"></a>01363             <span class="keywordflow">for</span>(<span class="keywordtype">int</span> l=0; l&lt;ext_param_.class_count_; ++l)
<a name="l01364"></a>01364             {
<a name="l01365"></a>01365                 <span class="keywordtype">double</span> cur_w = weights[l] * (weighted * (*(weights-1))
<a name="l01366"></a>01366                                            + (1-weighted));
<a name="l01367"></a>01367                 prob(row, l) += (T)cur_w;
<a name="l01368"></a>01368                 <span class="comment">//every weight in totalWeight.</span>
<a name="l01369"></a>01369                 totalWeight += cur_w;
<a name="l01370"></a>01370             }
<a name="l01371"></a>01371         }
<a name="l01372"></a>01372     }
<a name="l01373"></a>01373     prob/= options_.tree_count_;
<a name="l01374"></a>01374 
<a name="l01375"></a>01375 }
<a name="l01376"></a>01376 <span class="comment"></span>
<a name="l01377"></a>01377 <span class="comment">//@}</span>
<a name="l01378"></a>01378 <span class="comment"></span>
<a name="l01379"></a>01379 } <span class="comment">// namespace vigra</span>
<a name="l01380"></a>01380 
<a name="l01381"></a>01381 <span class="preprocessor">#include &quot;random_forest/rf_algorithm.hxx&quot;</span>
<a name="l01382"></a>01382 <span class="preprocessor">#endif // VIGRA_RANDOM_FOREST_HXX</span>
</pre></div></div><!-- contents -->
<!-- footer.html -->
<p>
<table border=0 cellspacing=0 width="100%"  bgcolor="#e0d0a0" cellpadding=5>
<tr>
<td>
<p>
<i>&copy; <A HREF="http://hci.iwr.uni-heidelberg.de/people/ukoethe/">Ullrich K&ouml;the</A>     (<A
HREF="mailto:ullrich.koethe@iwr.uni-heidelberg.de">ullrich.koethe@iwr.uni-heidelberg.de</A>)</i> <br>
<i><A HREF="http://hci.iwr.uni-heidelberg.de/">
Heidelberg Collaboratory for Image Processing</a>,
University of Heidelberg, Germany</i>
<td>
<p align=right>
<I>html generated using <A HREF="http://www.doxygen.org">doxygen</A> and <A HREF="http://www.python.org">Python</A></I>
<br>
<i>
vigra 1.9.1 (Thu Sep 5 2013)
</i>
</tr>
</table>


</BODY>
</HTML>
